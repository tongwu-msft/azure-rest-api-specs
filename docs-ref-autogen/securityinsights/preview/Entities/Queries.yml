### YamlMime:RESTOperation
uid: management.azure.com.securityinsights.preview.entities.queries
name: Queries
service: Sentinel
groupName: Entities
apiVersion: 2021-09-01-preview
summary: Get Insights and Activities for an entity.
consumes:
- application/json
produces:
- application/json
paths:
- content: GET https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.OperationalInsights/workspaces/{workspaceName}/providers/Microsoft.SecurityInsights/entities/{entityId}/queries?api-version=2021-09-01-preview&kind=Insight
uriParameters:
- name: subscriptionId
  in: path
  isRequired: true
  description: The ID of the target subscription.
  types:
  - uid: string
- name: resourceGroupName
  in: path
  isRequired: true
  description: The name of the resource group. The name is case insensitive.
  types:
  - uid: string
- name: workspaceName
  in: path
  isRequired: true
  description: The name of the workspace.
  types:
  - uid: string
- name: entityId
  in: path
  isRequired: true
  description: entity ID
  types:
  - uid: string
- name: api-version
  in: query
  isRequired: true
  description: The API version to use for this operation.
  types:
  - uid: string
- name: kind
  in: query
  isRequired: true
  description: The Kind parameter for queries
  types:
  - uid: EntityItemQueryKind
responses:
- name: 200 OK
  description: OK
  types:
  - uid: GetQueriesResponse
- name: Other Status Codes
  description: Error response describing why the operation failed.
  types:
  - uid: CloudError
requestHeader: []
definitions:
- name: EntityItemQueryKind
  description: The Kind parameter for queries
  kind: enum
  properties:
  - name: Insight
    description: insight
    types:
    - uid: string
- name: GetQueriesResponse
  description: Retrieve queries for entity result operation response.
  kind: object
  properties:
  - name: value
    description: The query result values.
    types:
    - uid: InsightQueryItem
      isArray: true
    typesTitle: EntityQueryItem[]
- name: CloudError
  description: Error response structure.
  kind: object
  properties:
  - name: error
    description: Error data
    types:
    - uid: CloudErrorBody
- name: CloudErrorBody
  description: Error details.
  kind: object
  properties:
  - name: code
    isReadyOnly: true
    description: An identifier for the error. Codes are invariant and are intended to be consumed programmatically.
    types:
    - uid: string
  - name: message
    isReadyOnly: true
    description: A message describing the error, intended to be suitable for display in a user interface.
    types:
    - uid: string
- name: InsightQueryItem
  description: Represents Insight Query.
  kind: object
  properties:
  - name: properties
    description: Properties bag for InsightQueryItem
    types:
    - uid: InsightQueryItemProperties
  - name: id
    isReadyOnly: true
    description: Query Template ARM ID
    types:
    - uid: string
  - name: name
    description: Query Template ARM Name
    types:
    - uid: string
  - name: type
    description: ARM Type
    types:
    - uid: string
  - name: kind
    description: The kind of the entity query
    types:
    - uid: Insight
    typesTitle: string
- name: InsightQueryItemProperties
  description: Represents Insight Query.
  kind: object
  properties:
  - name: displayName
    description: The insight display name.
    types:
    - uid: string
  - name: description
    description: The insight description.
    types:
    - uid: string
  - name: baseQuery
    description: The base query of the insight.
    types:
    - uid: string
  - name: tableQuery
    description: The insight table query.
    types:
    - uid: TableQuery
  - name: chartQuery
    description: The insight chart query.
    types:
    - uid: object
  - name: additionalQuery
    description: The activity query definitions.
    types:
    - uid: AdditionalQuery
  - name: defaultTimeRange
    description: The insight chart query.
    types:
    - uid: DefaultTimeRange
  - name: referenceTimeRange
    description: The insight chart query.
    types:
    - uid: ReferenceTimeRange
  - name: dataTypes
    description: Data types for template
    types:
    - uid: DataTypes
      isArray: true
  - name: inputEntityType
    description: The type of the entity
    types:
    - uid: EntityType
  - name: requiredInputFieldsSets
    description: Data types for template
    types:
    - uid: array
      isArray: true
  - name: entitiesFilter
    description: The query applied only to entities matching to all filters
    types:
    - uid: object
- name: EntityQueryKind
  description: The kind of the entity query
  kind: enum
  properties:
  - name: Expansion
    types:
    - uid: string
  - name: Insight
    types:
    - uid: string
  - name: Activity
    types:
    - uid: string
- name: TableQuery
  description: The insight table query.
  kind: object
  properties:
  - name: columnsDefinitions
    description: List of insight column definitions.
    types:
    - uid: ColumnsDefinitions
      isArray: true
  - name: queriesDefinitions
    description: List of insight queries definitions.
    types:
    - uid: QueriesDefinitions
      isArray: true
- name: AdditionalQuery
  description: The activity query definitions.
  kind: object
  properties:
  - name: query
    description: The insight query.
    types:
    - uid: string
  - name: text
    description: The insight text.
    types:
    - uid: string
- name: DefaultTimeRange
  description: The insight chart query.
  kind: object
  properties:
  - name: beforeRange
    description: The padding for the start time of the query.
    types:
    - uid: string
  - name: afterRange
    description: The padding for the end time of the query.
    types:
    - uid: string
- name: ReferenceTimeRange
  description: The insight chart query.
  kind: object
  properties:
  - name: beforeRange
    description: Additional query time for looking back.
    types:
    - uid: string
- name: DataTypes
  description: Data types for template
  kind: object
  properties:
  - name: dataType
    description: Data type name
    types:
    - uid: string
- name: EntityType
  description: The type of the entity
  kind: enum
  properties:
  - name: Account
    description: Entity represents account in the system.
    types:
    - uid: string
  - name: Host
    description: Entity represents host in the system.
    types:
    - uid: string
  - name: File
    description: Entity represents file in the system.
    types:
    - uid: string
  - name: AzureResource
    description: Entity represents azure resource in the system.
    types:
    - uid: string
  - name: CloudApplication
    description: Entity represents cloud application in the system.
    types:
    - uid: string
  - name: DNS
    description: Entity represents dns in the system.
    types:
    - uid: string
  - name: FileHash
    description: Entity represents file hash in the system.
    types:
    - uid: string
  - name: IP
    description: Entity represents ip in the system.
    types:
    - uid: string
  - name: Malware
    description: Entity represents malware in the system.
    types:
    - uid: string
  - name: Process
    description: Entity represents process in the system.
    types:
    - uid: string
  - name: RegistryKey
    description: Entity represents registry key in the system.
    types:
    - uid: string
  - name: RegistryValue
    description: Entity represents registry value in the system.
    types:
    - uid: string
  - name: SecurityGroup
    description: Entity represents security group in the system.
    types:
    - uid: string
  - name: URL
    description: Entity represents url in the system.
    types:
    - uid: string
  - name: IoTDevice
    description: Entity represents IoT device in the system.
    types:
    - uid: string
  - name: SecurityAlert
    description: Entity represents security alert in the system.
    types:
    - uid: string
  - name: HuntingBookmark
    description: Entity represents HuntingBookmark in the system.
    types:
    - uid: string
  - name: MailCluster
    description: Entity represents mail cluster in the system.
    types:
    - uid: string
  - name: MailMessage
    description: Entity represents mail message in the system.
    types:
    - uid: string
  - name: Mailbox
    description: Entity represents mailbox in the system.
    types:
    - uid: string
  - name: SubmissionMail
    description: Entity represents submission mail in the system.
    types:
    - uid: string
- name: ColumnsDefinitions
  description: List of insight column definitions.
  kind: object
  properties:
  - name: header
    description: Insight column header.
    types:
    - uid: string
  - name: outputType
    description: Insights Column type.
    types:
    - uid: outputType
  - name: supportDeepLink
    description: Is query supports deep-link.
    types:
    - uid: boolean
- name: QueriesDefinitions
  description: List of insight queries definitions.
  kind: object
  properties:
  - name: filter
    description: Insight column header.
    types:
    - uid: string
  - name: summarize
    description: Insight column header.
    types:
    - uid: string
  - name: project
    description: Insight column header.
    types:
    - uid: string
  - name: linkColumnsDefinitions
    description: Insight column header.
    types:
    - uid: LinkColumnsDefinitions
      isArray: true
- name: outputType
  description: Insights Column type.
  kind: enum
  properties:
  - name: Number
    types:
    - uid: string
  - name: String
    types:
    - uid: string
  - name: Date
    types:
    - uid: string
  - name: Entity
    types:
    - uid: string
- name: LinkColumnsDefinitions
  description: Insight column header.
  kind: object
  properties:
  - name: projectedName
    description: Insight Link Definition Projected Name.
    types:
    - uid: string
  - name: Query
    description: Insight Link Definition Query.
    types:
    - uid: string
examples:
- name: Get Entity Query
  request:
    uri: GET https://management.azure.com/subscriptions/d0cfe6b2-9ac0-4464-9919-dccaee2e48c0/resourceGroups/myRg/providers/Microsoft.OperationalInsights/workspaces/myWorkspace/providers/Microsoft.SecurityInsights/entities/e1d3d618-e11f-478b-98e3-bb381539a8e1/queries?api-version=2021-09-01-preview&kind=Insight
  responses:
  - statusCode: "200"
    body: >-
      {
        "value": [
          {
            "id": "/subscriptions/d0cfe6b2-9ac0-4464-9919-dccaee2e48c0/resourceGroups/myRg/providers/Microsoft.OperationalInsights/workspaces/myWorkspace/providers/Microsoft.SecurityInsights/entities/e1d3d618-e11f-478b-98e3-bb381539a8e1/queries/6db7f5d1-f41e-46c2-b935-230b36a569e6",
            "name": "6db7f5d1-f41e-46c2-b935-230b36a569e6",
            "type": "Microsoft.SecurityInsights/entities/queries",
            "kind": "Insight",
            "properties": {
              "displayName": "Actions on account",
              "description": "Summary of actions taken on the specified account, grouped by action: password resets and changes, account lockouts (policy or admin), account creation and deletion, account enabled and disabled\n",
              "baseQuery": "let GetAccountActions = (v_Account_Name:string, v_Account_NTDomain:string, v_Account_UPNSuffix:string, v_Account_AADUserId:string, v_Account_SID:string){\nAuditLogs\n| where OperationName in~ ('Delete user', 'Change user password', 'Reset user password', 'Change password (self-service)',  'Reset password (by admin)', 'Reset password (self-service)', 'Update user')\n| extend UserPrincipalName = tostring(TargetResources[0].userPrincipalName)\n| extend Account_Name = tostring(split(UserPrincipalName, '@')[0])\n| extend Account_UPNSuffix = tostring(split(UserPrincipalName, '@')[1])\n| extend Action = tostring(parse_json(tostring(parse_json(tostring(TargetResources[0].modifiedProperties))[0])))\n| extend ModifiedProperty = parse_json(Action).displayName\n| extend ModifiedValue = parse_json(Action).newValue\n| extend Account_AADUserId = tostring(TargetResources[0].id)\n| extend DisableUser = iif(ModifiedProperty =~ 'AccountEnabled' and ModifiedValue =~ '[false]', 'True', 'False')\n| union isfuzzy=true (\nSecurityEvent\n| where EventID in (4720, 4722, 4723, 4724, 4725, 4726, 4740)\n| extend OperationName = tostring(EventID)\n| where AccountType =~ \"user\" or isempty(AccountType)\n| extend Account_Name = TargetUserName, Account_NTDomain = TargetDomainName, Account_SID = TargetSid\n)\n| where (Account_Name =~ v_Account_Name and (Account_UPNSuffix =~ v_Account_UPNSuffix or Account_NTDomain =~ v_Account_NTDomain)) or Account_AADUserId =~ v_Account_AADUserId or Account_SID =~ v_Account_SID\n};\nGetAccountActions('CTFFUser4', '', 'seccxp.ninja', '', '')\n",
              "tableQuery": {
                "columnsDefinitions": [
                  {
                    "header": "Action",
                    "outputType": "String",
                    "supportDeepLink": false
                  },
                  {
                    "header": "Most Recent",
                    "outputType": "Date",
                    "supportDeepLink": false
                  },
                  {
                    "header": "Count",
                    "outputType": "Number",
                    "supportDeepLink": true
                  }
                ],
                "queriesDefinitions": [
                  {
                    "filter": "where OperationName in~ ('Change user password', 'Reset user password', 'Change password (self-service)',  'Reset password (by admin)', 'Reset password (self-service)', '4724', '4723')",
                    "summarize": "summarize MostRecent = max(TimeGenerated), Count = count() by OperationName",
                    "project": "project Title = OperationName, MostRecent, Count",
                    "linkColumnsDefinitions": [
                      {
                        "projectedName": "Count",
                        "Query": "{{BaseQuery}} | "
                      }
                    ]
                  },
                  {
                    "filter": "where OperationName in~ ('Blocked from self-service password reset', '4740')",
                    "summarize": "summarize MostRecent = max(TimeGenerated), Count = count() by OperationName",
                    "project": "project Title = OperationName, MostRecent, Count",
                    "linkColumnsDefinitions": [
                      {
                        "projectedName": "Count",
                        "Query": "{{BaseQuery}} | "
                      }
                    ]
                  },
                  {
                    "filter": "where OperationName  == '4725' or (OperationName  =~ 'Update user' and DisableUser =~ 'True')",
                    "summarize": "summarize MostRecent = max(TimeGenerated), Count = count() by OperationName",
                    "project": "project Title = OperationName, MostRecent, Count",
                    "linkColumnsDefinitions": [
                      {
                        "projectedName": "Count",
                        "Query": "{{BaseQuery}} | "
                      }
                    ]
                  },
                  {
                    "filter": "where OperationName in~ ('Add user', '4720')",
                    "summarize": "summarize MostRecent = max(TimeGenerated), Count = count() by OperationName",
                    "project": "project Title = OperationName, MostRecent, Count",
                    "linkColumnsDefinitions": [
                      {
                        "projectedName": "Count",
                        "Query": "{{BaseQuery}} | "
                      }
                    ]
                  },
                  {
                    "filter": "where OperationName in~ ('Delete user', '4726')",
                    "summarize": "summarize MostRecent = max(TimeGenerated), Count = count() by OperationName",
                    "project": "project Title = OperationName, MostRecent, Count",
                    "linkColumnsDefinitions": [
                      {
                        "projectedName": "Count",
                        "Query": "{{BaseQuery}} | "
                      }
                    ]
                  },
                  {
                    "filter": "where OperationName in~ ('4725', 'Blocked from self-service password reset', '4740') or (OperationName  =~ 'Update user' and DisableUser =~ 'True')",
                    "summarize": "summarize MostRecent = max(TimeGenerated), Count = count() by OperationName",
                    "project": "project Title = OperationName, MostRecent, Count",
                    "linkColumnsDefinitions": [
                      {
                        "projectedName": "Count",
                        "Query": "{{BaseQuery}} | "
                      }
                    ]
                  },
                  {
                    "filter": "where OperationName in~ ('4722', '4767') or (OperationName  =~ 'Update user' and DisableUser =~ 'False')",
                    "summarize": "summarize MostRecent = max(TimeGenerated), Count = count() by OperationName",
                    "project": "project Title = OperationName, MostRecent, Count",
                    "linkColumnsDefinitions": [
                      {
                        "projectedName": "Count",
                        "Query": "{{BaseQuery}} | "
                      }
                    ]
                  },
                  {
                    "filter": "where OperationName in~ ('Update user','4738')",
                    "summarize": "summarize MostRecent = max(TimeGenerated), Count = count() by OperationName",
                    "project": "project Title = OperationName, MostRecent, Count",
                    "linkColumnsDefinitions": [
                      {
                        "projectedName": "Count",
                        "Query": "{{BaseQuery}} | "
                      }
                    ]
                  }
                ]
              },
              "chartQuery": {
                "title": "Actions by type",
                "dataSets": [
                  {
                    "query": "summarize Count = count() by bin(TimeGenerated, 1h), OperationName",
                    "xColumnName": "TimeGenerated",
                    "yColumnName": "Count",
                    "legendColumnName": "OperationName"
                  }
                ],
                "type": "BarChart"
              },
              "additionalQuery": {
                "text": "See all account activity",
                "query": "project TimeGenerated, UserPrincipalName, Account_Name, OperationName, Activity, DisableUser, TargetSid, AADUserId, InitiatedBy, AADTenantId, AccountType, Computer, SubjectAccount, SubjectUserSid, EventData"
              },
              "defaultTimeRange": {
                "beforeRange": "12h",
                "afterRange": "12h"
              },
              "referenceTimeRange": null,
              "dataTypes": [
                {
                  "dataType": "AuditLogs"
                },
                {
                  "dataType": "SecurityEvent"
                }
              ],
              "inputEntityType": "Account",
              "requiredInputFieldsSets": [
                [
                  "Account_Name",
                  "Account_NTDomain"
                ],
                [
                  "Account_Name",
                  "Account_UPNSuffix"
                ],
                [
                  "Account_AADUserId"
                ],
                [
                  "Account_SID"
                ]
              ],
              "entitiesFilter": {}
            }
          },
          {
            "id": "/subscriptions/d0cfe6b2-9ac0-4464-9919-dccaee2e48c0/resourceGroups/myRg/providers/Microsoft.OperationalInsights/workspaces/myWorkspace/providers/Microsoft.SecurityInsights/entities/e1d3d618-e11f-478b-98e3-bb381539a8e1/queries/0a5d7b14-b485-450a-a0ac-4100c860ac32",
            "name": "0a5d7b14-b485-450a-a0ac-4100c860ac32",
            "type": "Microsoft.SecurityInsights/entities/queries",
            "kind": "Insight",
            "properties": {
              "displayName": "Anomalously high office operation count",
              "description": "Highlight office operations of the user with anomalously high count compared to those observed in the preceding 14 days.",
              "baseQuery": "let AScoreThresh = 3; \nlet maxAnomalies = 3;\nlet BeforeRange = 12d; \nlet EndTime = todatetime('{{EndTimeUTC}}'); \nlet StartTime = todatetime('{{StartTimeUTC}}');\nlet numDays = tolong((EndTime-StartTime)/1d); \nlet userData = (v_Account_Name:string, v_Account_UPNSuffix:string) { \n  OfficeActivity \n  | extend splitUserId=split(UserId, '@')\n  | extend Account_Name = tostring(splitUserId[0]), Account_UPNSuffix = tostring(splitUserId[1])\n  | where Account_Name =~ v_Account_Name and Account_UPNSuffix =~ v_Account_UPNSuffix }; \nuserData('CTFFUser4', 'seccxp.ninja')\n",
              "tableQuery": {
                "columnsDefinitions": [
                  {
                    "header": "Operation",
                    "outputType": "String",
                    "supportDeepLink": true
                  },
                  {
                    "header": "Expected Count",
                    "outputType": "Number",
                    "supportDeepLink": false
                  },
                  {
                    "header": "Actual Count",
                    "outputType": "Number",
                    "supportDeepLink": false
                  }
                ],
                "queriesDefinitions": [
                  {
                    "filter": "make-series count() default=0 on TimeGenerated from (StartTime - BeforeRange) to EndTime step 1d by Operation \n| extend (anomalies,anomalyScore, expectedCount)=series_decompose_anomalies(count_,AScoreThresh,7,'linefit',numDays, 'ctukey') \n| extend count1=count_, TimeGenerated1=TimeGenerated, anomalyScore1=anomalyScore\n| mv-apply count1 to typeof(long), TimeGenerated1 to typeof(datetime), anomalyScore1 to typeof(double), anomalies to typeof(long) on (summarize totAnomalies=sumif(abs(anomalies), TimeGenerated1 < StartTime), baseStd=stdevif(count1, TimeGenerated1 < StartTime), baseAvg=avgif(count1, TimeGenerated1 < StartTime), maxCountPost=maxif(count1,TimeGenerated1 >= StartTime), maxAnomalyScorePost=maxif(anomalyScore1, TimeGenerated1 >= StartTime)) \n| extend count1=count_ \n| mv-apply count1 to typeof(long), anomalyScore to typeof(double), expectedCount to typeof(double) on ( summarize (dummy, postExpectedCount, postActualCount)=arg_min(abs(anomalyScore-maxAnomalyScorePost), expectedCount, count1) ) \n| where totAnomalies < maxAnomalies \n| extend postAnomalyScore=iff(baseStd == 0 and maxCountPost > tolong(count_[0]),1000.0,maxAnomalyScorePost), postExpectedCount=iff(postExpectedCount < 0,0.0,postExpectedCount) \n| where maxAnomalyScorePost > AScoreThresh \n| order by maxAnomalyScorePost desc\n",
                    "summarize": "take 1",
                    "project": "project Operation, expectedCount=round(postExpectedCount,2), actualCount=postActualCount, anomalyScore=round(postAnomalyScore,2)",
                    "linkColumnsDefinitions": [
                      {
                        "projectedName": "Operation",
                        "Query": "{{BaseQuery}} \n| where TimeGenerated between (StartTime .. EndTime) \n| where Operation == ''\n"
                      }
                    ]
                  }
                ]
              },
              "chartQuery": {
                "title": "Anomalous operation timeline",
                "dataSets": [
                  {
                    "query": "make-series count() default=0 on TimeGenerated from (StartTime - BeforeRange) to EndTime step 1d by Operation \n| extend (anomalies,anomalyScore, expectedCount)=series_decompose_anomalies(count_,AScoreThresh,7,'linefit',numDays, 'ctukey') \n| extend count1=count_, TimeGenerated1=TimeGenerated, anomalyScore1=anomalyScore\n| mv-apply count1 to typeof(long), TimeGenerated1 to typeof(datetime), anomalyScore1 to typeof(double), anomalies to typeof(long) on (summarize totAnomalies=sumif(abs(anomalies), TimeGenerated1 < StartTime), baseStd=stdevif(count1, TimeGenerated1 < StartTime), baseAvg=avgif(count1, TimeGenerated1 < StartTime), maxCountPost=maxif(count1,TimeGenerated1 >= StartTime), maxAnomalyScorePost=maxif(anomalyScore1, TimeGenerated1 >= StartTime)) \n| extend count1=count_ \n| mv-apply count1 to typeof(long), anomalyScore to typeof(double), expectedCount to typeof(double) on ( summarize (dummy, postExpectedCount, postActualCount)=arg_min(abs(anomalyScore-maxAnomalyScorePost), expectedCount, count1) ) \n| where totAnomalies < maxAnomalies \n| extend postAnomalyScore=iff(baseStd == 0 and maxCountPost > tolong(count_[0]),1000.0,maxAnomalyScorePost), postExpectedCount=iff(postExpectedCount < 0,0.0,round(postExpectedCount,2)) \n| where maxAnomalyScorePost > AScoreThresh \n| order by maxAnomalyScorePost desc \n| take 1 \n| project Operation, TimeGenerated, count_\n| mvexpand TimeGenerated, count_ | project todatetime(TimeGenerated), toint(count_), Operation\n",
                    "xColumnName": "TimeGenerated",
                    "yColumnName": "count_",
                    "legendColumnName": "Operation"
                  }
                ],
                "type": "LineChart"
              },
              "additionalQuery": {
                "text": "Query all anomalous operations",
                "query": "make-series count() default=0 on TimeGenerated from (StartTime - BeforeRange) to EndTime step 1d by Operation \n| extend (anomalies,anomalyScore, expectedCount)=series_decompose_anomalies(count_,AScoreThresh,7,'linefit',numDays, 'ctukey') \n| extend count1=count_, TimeGenerated1=TimeGenerated, anomalyScore1=anomalyScore\n| mv-apply count1 to typeof(long), TimeGenerated1 to typeof(datetime), anomalyScore1 to typeof(double), anomalies to typeof(long) on (summarize totAnomalies=sumif(abs(anomalies), TimeGenerated1 < StartTime), baseStd=stdevif(count1, TimeGenerated1 < StartTime), baseAvg=avgif(count1, TimeGenerated1 < StartTime), maxCountPost=maxif(count1,TimeGenerated1 >= StartTime), maxAnomalyScorePost = maxif(anomalyScore1, TimeGenerated1 >= StartTime)) \n| extend count1=count_\n| mv-apply  count1 to typeof(long), anomalyScore to typeof(double), expectedCount to typeof(double) on ( summarize (dummy, postExpectedCount, postActualCount)=arg_min(abs(anomalyScore - maxAnomalyScorePost), expectedCount, count1) ) \n| where totAnomalies < maxAnomalies\n| extend postAnomalyScore=iff(baseStd == 0 and maxCountPost > tolong(count_[0]),1000.0,maxAnomalyScorePost), postExpectedCount=iff(postExpectedCount < 0,0.0,postExpectedCount) \n| where maxAnomalyScorePost > AScoreThresh | order by maxAnomalyScorePost desc \n| project Operation, expectedCount=round(postExpectedCount,2), actualCount=postActualCount, anomalyScore=round(postAnomalyScore,2)\n"
              },
              "defaultTimeRange": {
                "beforeRange": "1d",
                "afterRange": "0d"
              },
              "referenceTimeRange": {
                "beforeRange": "12d"
              },
              "dataTypes": [
                {
                  "dataType": "OfficeActivity"
                }
              ],
              "inputEntityType": "Account",
              "requiredInputFieldsSets": [
                [
                  "Account_Name",
                  "Account_UPNSuffix"
                ]
              ],
              "entitiesFilter": {}
            }
          },
          {
            "id": "/subscriptions/d0cfe6b2-9ac0-4464-9919-dccaee2e48c0/resourceGroups/myRg/providers/Microsoft.OperationalInsights/workspaces/myWorkspace/providers/Microsoft.SecurityInsights/entities/e1d3d618-e11f-478b-98e3-bb381539a8e1/queries/e6cf68e6-1eca-4fbb-9fad-6280f2a9476e",
            "name": "e6cf68e6-1eca-4fbb-9fad-6280f2a9476e",
            "type": "Microsoft.SecurityInsights/entities/queries",
            "kind": "Insight",
            "properties": {
              "displayName": "Resource access",
              "description": "Provides the count and distinct resource accesses by a given user account\n",
              "baseQuery": "let Operations = dynamic([\"FileDownloaded\", \"FileUploaded\"]);\nlet UserOperationToSharePoint =  (v_Account_Name:string, v_Account_UPNSuffix:string) {\nOfficeActivity\n// Select sharepoint activity that is relevant\n| where RecordType in~ ('SharePointFileOperation')\n| where Operation in~ (Operations)\n| extend Account_Name = tostring(split(UserId, '@')[0])\n| extend Account_UPNSuffix = tostring(split(UserId, '@')[1])\n| where Account_Name =~ v_Account_Name and Account_UPNSuffix =~ v_Account_UPNSuffix\n| project TimeGenerated, Account_Name, Account_UPNSuffix, UserId, OfficeId, RecordType, Operation, OrganizationId, UserType, UserKey, OfficeWorkload, OfficeObjectId, ClientIP, ItemType, UserAgent, Site_Url, SourceRelativeUrl, SourceFileName, SourceFileExtension , Start_Time , ElevationTime , TenantId, SourceSystem , Type\n};\nUserOperationToSharePoint ('CTFFUser4','seccxp.ninja')\n",
              "tableQuery": {
                "columnsDefinitions": [
                  {
                    "header": "Resource Type",
                    "outputType": "String",
                    "supportDeepLink": false
                  },
                  {
                    "header": "Distinct Resources",
                    "outputType": "Number",
                    "supportDeepLink": true
                  },
                  {
                    "header": "Total Resources",
                    "outputType": "Number",
                    "supportDeepLink": true
                  },
                  {
                    "header": "IPAddress(es)",
                    "outputType": "String",
                    "supportDeepLink": false
                  }
                ],
                "queriesDefinitions": [
                  {
                    "filter": "where Operation =~ 'FileUploaded'",
                    "summarize": "summarize DistinctResources = dcount(SourceFileName), TotalResources = count(SourceFileName), IPAddresses = make_set(ClientIP) by Operation",
                    "project": "project Title = Operation, DistinctResources, TotalResources, IPAddresses = case(array_length(IPAddresses) == 1, tostring(IPAddresses[0]), array_length(IPAddresses) > 1, 'Many', 'None')",
                    "linkColumnsDefinitions": [
                      {
                        "projectedName": "DistinctResources",
                        "Query": "{{BaseQuery}} | "
                      },
                      {
                        "projectedName": "TotalResources",
                        "Query": "{{BaseQuery}} | "
                      }
                    ]
                  },
                  {
                    "filter": "where Operation =~ 'FileDownloaded'",
                    "summarize": "summarize DistinctResources = dcount(SourceFileName), TotalResources = count(SourceFileName), IPAddresses = make_set(ClientIP) by Operation",
                    "project": "project Title = Operation, DistinctResources, TotalResources, IPAddresses = case(array_length(IPAddresses) == 1, tostring(IPAddresses[0]), array_length(IPAddresses) > 1, 'Many', 'None')",
                    "linkColumnsDefinitions": [
                      {
                        "projectedName": "DistinctResources",
                        "Query": "{{BaseQuery}} | "
                      },
                      {
                        "projectedName": "TotalResources",
                        "Query": "{{BaseQuery}} | "
                      }
                    ]
                  }
                ]
              },
              "chartQuery": {
                "title": "Resource access over time",
                "dataSets": [
                  {
                    "query": "summarize DistinctResources = dcountif(Operation, Operation =~ 'FileUploaded'), TotalResources = countif(Operation =~ 'FileUploaded') by bin(TimeGenerated, 1h) | extend Legend = 'File Uploads'",
                    "xColumnName": "TimeGenerated",
                    "yColumnName": "TotalResources",
                    "legendColumnName": "Legend"
                  },
                  {
                    "query": "summarize DistinctResources = dcountif(Operation, Operation =~ 'FileDownloaded'), TotalResources = countif(Operation =~ 'FileDownloaded') by bin(TimeGenerated, 1h) | extend Legend = 'File Downloads'",
                    "xColumnName": "TimeGenerated",
                    "yColumnName": "TotalResources",
                    "legendColumnName": "Legend"
                  }
                ],
                "type": "LineChart"
              },
              "additionalQuery": {
                "text": "See all resource activity",
                "query": "where Operation in~ (Operations)"
              },
              "defaultTimeRange": {
                "beforeRange": "12h",
                "afterRange": "12h"
              },
              "referenceTimeRange": null,
              "dataTypes": [
                {
                  "dataType": "OfficeActivity"
                }
              ],
              "inputEntityType": "Account",
              "requiredInputFieldsSets": [
                [
                  "Account_Name",
                  "Account_UPNSuffix"
                ],
                [
                  "Account_AADUserId"
                ]
              ],
              "entitiesFilter": {}
            }
          },
          {
            "id": "/subscriptions/d0cfe6b2-9ac0-4464-9919-dccaee2e48c0/resourceGroups/myRg/providers/Microsoft.OperationalInsights/workspaces/myWorkspace/providers/Microsoft.SecurityInsights/entities/e1d3d618-e11f-478b-98e3-bb381539a8e1/queries/cae8d0aa-aa45-4d53-8d88-17dd64ffd4e4",
            "name": "cae8d0aa-aa45-4d53-8d88-17dd64ffd4e4",
            "type": "Microsoft.SecurityInsights/entities/queries",
            "kind": "Insight",
            "properties": {
              "displayName": "Anomalously high Azure sign-in result count",
              "description": "Highlight Azure sign-in results by the user principal with anomalously high count compared to those observed in the preceding 14 days.",
              "baseQuery": "let AScoreThresh=3; \nlet maxAnomalies=3; \nlet BeforeRange = 12d; \nlet EndTime=todatetime('{{EndTimeUTC}}');\nlet StartTime = todatetime('{{StartTimeUTC}}'); \nlet numDays = tolong((EndTime-StartTime)/1d); \nlet userData = (v_Account_Name:string, v_Account_UPNSuffix:string, v_Account_AADUserId:string) { \n   SigninLogs \n   | where TimeGenerated between ((StartTime-BeforeRange) .. EndTime)\n   | extend splitUserId=split(UserPrincipalName, '@')\n   | extend Account_Name = tostring(splitUserId[0]), Account_UPNSuffix = tostring(splitUserId[1])\n   | where (Account_Name =~ v_Account_Name and Account_UPNSuffix =~ v_Account_UPNSuffix) or UserId =~ v_Account_AADUserId };\nuserData('CTFFUser4', 'seccxp.ninja', '')\n",
              "tableQuery": {
                "columnsDefinitions": [
                  {
                    "header": "Result Description",
                    "outputType": "String",
                    "supportDeepLink": true
                  },
                  {
                    "header": "Expected Count",
                    "outputType": "Number",
                    "supportDeepLink": false
                  },
                  {
                    "header": "Actual Count",
                    "outputType": "Number",
                    "supportDeepLink": false
                  }
                ],
                "queriesDefinitions": [
                  {
                    "filter": "make-series count() default=0 on TimeGenerated from (StartTime - BeforeRange) to EndTime step 1d by ResultDescription \n| extend (anomalies,anomalyScore, expectedCount)=series_decompose_anomalies(count_,AScoreThresh,7,'linefit',numDays, 'ctukey') \n| extend count1=count_, TimeGenerated1=TimeGenerated, anomalyScore1=anomalyScore\n| mv-apply count1 to typeof(long), TimeGenerated1 to typeof(datetime), anomalyScore1 to typeof(double), anomalies to typeof(long) on (summarize totAnomalies=sumif(abs(anomalies), TimeGenerated1 < StartTime), baseStd=stdevif(count1, TimeGenerated1 < StartTime), baseAvg=avgif(count1, TimeGenerated1 < StartTime), maxCountPost=maxif(count1,TimeGenerated1 >= StartTime), maxAnomalyScorePost = maxif(anomalyScore1, TimeGenerated1 >= StartTime)) \n| extend count1=count_ \n| mv-apply  count1 to typeof(long), anomalyScore to typeof(double), expectedCount to typeof(double) on ( summarize (dummy, postExpectedCount, postActualCount)=arg_min(abs(anomalyScore - maxAnomalyScorePost), expectedCount, count1) ) \n| where totAnomalies < maxAnomalies \n| extend postAnomalyScore=iff(baseStd == 0 and maxCountPost > tolong(count_[0]),1000.0,maxAnomalyScorePost), postExpectedCount=iff(postExpectedCount < 0,0.0,postExpectedCount) \n| where maxAnomalyScorePost > AScoreThresh \n| order by maxAnomalyScorePost desc\n",
                    "summarize": "take 1",
                    "project": "project ResultDescription, expectedCount=round(postExpectedCount,2), actualCount=postActualCount, anomalyScore=round(postAnomalyScore,2)",
                    "linkColumnsDefinitions": [
                      {
                        "projectedName": "ResultDescription",
                        "Query": "{{BaseQuery}} \n| where TimeGenerated between (StartTime .. EndTime) \n| where ResultDescription == ''\n"
                      }
                    ]
                  }
                ]
              },
              "chartQuery": {
                "title": "Anomalous sign-in result timeline",
                "dataSets": [
                  {
                    "query": "make-series count() default=0 on TimeGenerated from (StartTime - BeforeRange) to EndTime step 1d by ResultDescription \n| extend (anomalies,anomalyScore, expectedCount)=series_decompose_anomalies(count_,AScoreThresh,7,'linefit',numDays, 'ctukey') \n| extend count1=count_, TimeGenerated1=TimeGenerated, anomalyScore1=anomalyScore\n| mv-apply count1 to typeof(long), TimeGenerated1 to typeof(datetime), anomalyScore1 to typeof(double), anomalies to typeof(long) on (summarize totAnomalies=sumif(abs(anomalies), TimeGenerated1 < StartTime), baseStd=stdevif(count1, TimeGenerated1 < StartTime), baseAvg=avgif(count1, TimeGenerated1 < StartTime), maxCountPost=maxif(count1,TimeGenerated1 >= StartTime), maxAnomalyScorePost = maxif(anomalyScore1, TimeGenerated1 >= StartTime)) \n| extend count1=count_ \n| mv-apply  count1 to typeof(long), anomalyScore to typeof(double), expectedCount to typeof(double) on ( summarize (dummy, postExpectedCount, postActualCount)=arg_min(abs(anomalyScore - maxAnomalyScorePost), expectedCount, count1) ) \n| where totAnomalies < maxAnomalies \n| extend postAnomalyScore=iff(baseStd == 0 and maxCountPost > tolong(count_[0]),1000.0,maxAnomalyScorePost), postExpectedCount=iff(postExpectedCount < 0,0.0,round(postExpectedCount,2)) \n| where maxAnomalyScorePost > AScoreThresh \n| order by maxAnomalyScorePost desc \n| take 1 \n| project ResultDescription, TimeGenerated, count_ \n| mvexpand TimeGenerated, count_ \n| project todatetime(TimeGenerated), toint(count_), ResultDescription \n",
                    "xColumnName": "TimeGenerated",
                    "yColumnName": "count_",
                    "legendColumnName": "ResultDescription"
                  }
                ],
                "type": "LineChart"
              },
              "additionalQuery": {
                "text": "Query all anomalous sign-in results",
                "query": "make-series count() default=0 on TimeGenerated from (StartTime - BeforeRange) to EndTime step 1d by ResultDescription \n| extend (anomalies,anomalyScore, expectedCount)=series_decompose_anomalies(count_,AScoreThresh,7,'linefit',numDays, 'ctukey') \n| extend count1=count_, TimeGenerated1=TimeGenerated, anomalyScore1=anomalyScore\n| mv-apply count1 to typeof(long), TimeGenerated1 to typeof(datetime), anomalyScore1 to typeof(double), anomalies to typeof(long) on (summarize totAnomalies=sumif(abs(anomalies), TimeGenerated1 < StartTime), baseStd=stdevif(count1, TimeGenerated1 < StartTime), baseAvg=avgif(count1, TimeGenerated1 < StartTime), maxCountPost=maxif(count1,TimeGenerated1 >= StartTime), maxAnomalyScorePost = maxif(anomalyScore1, TimeGenerated1 >= StartTime)) \n| extend count1=count_\n| mv-apply  count1 to typeof(long), anomalyScore to typeof(double), expectedCount to typeof(double) on ( summarize (dummy, postExpectedCount, postActualCount)=arg_min(abs(anomalyScore - maxAnomalyScorePost), expectedCount, count1) ) \n| where totAnomalies < maxAnomalies\n| extend postAnomalyScore=iff(baseStd == 0 and maxCountPost > tolong(count_[0]),1000.0,maxAnomalyScorePost), postExpectedCount=iff(postExpectedCount < 0,0.0,postExpectedCount) \n| where maxAnomalyScorePost > AScoreThresh \n| order by maxAnomalyScorePost desc \n| project ResultDescription, expectedCount=round(postExpectedCount,2), actualCount=postActualCount, anomalyScore=round(postAnomalyScore,2)\n"
              },
              "defaultTimeRange": {
                "beforeRange": "1d",
                "afterRange": "0d"
              },
              "referenceTimeRange": {
                "beforeRange": "12d"
              },
              "dataTypes": [
                {
                  "dataType": "SigninLogs"
                }
              ],
              "inputEntityType": "Account",
              "requiredInputFieldsSets": [
                [
                  "Account_Name",
                  "Account_UPNSuffix"
                ],
                [
                  "Account_AADUserId"
                ]
              ],
              "entitiesFilter": {}
            }
          }
        ]
      }
security:
- name: azure_auth
  type: oauth2
  description: Azure Active Directory OAuth2 Flow
  flow: implicit
  authorizationUrl: https://login.microsoftonline.com/common/oauth2/authorize
  scopes:
  - name: user_impersonation
    description: impersonate your user account
metadata:
  description: Learn more about Sentinel service - Get Insights and Activities for an entity.
errorCodes: []
