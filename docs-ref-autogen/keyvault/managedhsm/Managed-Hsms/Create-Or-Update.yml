### YamlMime:RESTOperation
uid: management.azure.com.keyvault.managedhsm.managedhsms.createorupdate
name: Create Or Update
service: Key Vault
groupName: Managed Hsms
apiVersion: 2021-10-01
summary: Create or update a managed HSM Pool in the specified subscription.
consumes:
- application/json
produces:
- application/json
paths:
- content: PUT https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.KeyVault/managedHSMs/{name}?api-version=2021-10-01
uriParameters:
- name: subscriptionId
  in: path
  isRequired: true
  description: Subscription credentials which uniquely identify Microsoft Azure subscription. The subscription ID forms part of the URI for every service call.
  types:
  - uid: string
- name: resourceGroupName
  in: path
  isRequired: true
  description: Name of the resource group that contains the managed HSM pool.
  types:
  - uid: string
- name: name
  in: path
  isRequired: true
  description: Name of the managed HSM Pool
  types:
  - uid: string
- name: api-version
  in: query
  isRequired: true
  description: Client Api Version.
  types:
  - uid: string
responses:
- name: 202 Accepted
  description: Accepted and the operation will complete asynchronously.
  types:
  - uid: ManagedHsm
- name: 200 OK
  description: Created or updated managed HSM Pool
  types:
  - uid: ManagedHsm
- name: Other Status Codes
  description: The error response describing why the operation failed.
  types:
  - uid: ManagedHsmError
requestBody:
- name: default
  parameters:
  - name: properties
    in: body
    description: Properties of the managed HSM
    types:
    - uid: ManagedHsmProperties
  - name: location
    in: body
    description: The supported Azure location where the managed HSM Pool should be created.
    types:
    - uid: string
  - name: sku
    in: body
    description: SKU details
    types:
    - uid: ManagedHsmSku
  - name: tags
    in: body
    description: Resource tags
    types:
    - uid: object
      isDictionary: true
      additionalTypes:
      - uid: string
      - uid: string
requestHeader: []
definitions:
- name: ManagedHsmProperties
  description: Properties of the managed HSM Pool
  kind: object
  properties:
  - name: tenantId
    description: The Azure Active Directory tenant ID that should be used for authenticating requests to the managed HSM pool.
    types:
    - uid: string
  - name: initialAdminObjectIds
    description: Array of initial administrators object ids for this managed hsm pool.
    types:
    - uid: string
      isArray: true
  - name: hsmUri
    isReadyOnly: true
    description: The URI of the managed hsm pool for performing operations on keys.
    types:
    - uid: string
  - name: enableSoftDelete
    description: Property to specify whether the 'soft delete' functionality is enabled for this managed HSM pool. If it's not set to any value(true or false) when creating new managed HSM pool, it will be set to true by default. Once set to true, it cannot be reverted to false.
    types:
    - uid: boolean
    defaultValue: true
  - name: softDeleteRetentionInDays
    description: softDelete data retention days. It accepts >=7 and <=90.
    types:
    - uid: integer
    defaultValue: 90
  - name: enablePurgeProtection
    description: Property specifying whether protection against purge is enabled for this managed HSM pool. Setting this property to true activates protection against purge for this managed HSM pool and its content - only the Managed HSM service may initiate a hard, irrecoverable deletion. The setting is effective only if soft delete is also enabled. Enabling this functionality is irreversible.
    types:
    - uid: boolean
    defaultValue: true
  - name: createMode
    description: The create mode to indicate whether the resource is being created or is being recovered from a deleted resource.
    types:
    - uid: CreateMode
  - name: statusMessage
    isReadyOnly: true
    description: Resource Status Message.
    types:
    - uid: string
  - name: provisioningState
    isReadyOnly: true
    description: Provisioning state.
    types:
    - uid: ProvisioningState
  - name: networkAcls
    description: Rules governing the accessibility of the key vault from specific network locations.
    types:
    - uid: MHSMNetworkRuleSet
  - name: privateEndpointConnections
    isReadyOnly: true
    description: List of private endpoint connections associated with the managed hsm pool.
    types:
    - uid: MHSMPrivateEndpointConnectionItem
      isArray: true
  - name: publicNetworkAccess
    description: Control permission for data plane traffic coming from public networks while private endpoint is enabled.
    types:
    - uid: PublicNetworkAccess
  - name: scheduledPurgeDate
    isReadyOnly: true
    description: The scheduled purge date in UTC.
    types:
    - uid: string
- name: ManagedHsmSku
  description: SKU details
  kind: object
  properties:
  - name: family
    description: SKU Family of the managed HSM Pool
    types:
    - uid: ManagedHsmSkuFamily
  - name: name
    description: SKU of the managed HSM Pool
    types:
    - uid: ManagedHsmSkuName
- name: SystemData
  description: Metadata pertaining to creation and last modification of the key vault resource.
  kind: object
  properties:
  - name: createdBy
    description: The identity that created the key vault resource.
    types:
    - uid: string
  - name: createdByType
    description: The type of identity that created the key vault resource.
    types:
    - uid: identityType
  - name: createdAt
    description: The timestamp of the key vault resource creation (UTC).
    types:
    - uid: string
  - name: lastModifiedBy
    description: The identity that last modified the key vault resource.
    types:
    - uid: string
  - name: lastModifiedByType
    description: The type of identity that last modified the key vault resource.
    types:
    - uid: identityType
  - name: lastModifiedAt
    description: The timestamp of the key vault resource last modification (UTC).
    types:
    - uid: string
- name: ManagedHsm
  description: Resource information with extended details.
  kind: object
  properties:
  - name: properties
    description: Properties of the managed HSM
    types:
    - uid: ManagedHsmProperties
  - name: id
    isReadyOnly: true
    description: The Azure Resource Manager resource ID for the managed HSM Pool.
    types:
    - uid: string
  - name: name
    isReadyOnly: true
    description: The name of the managed HSM Pool.
    types:
    - uid: string
  - name: type
    isReadyOnly: true
    description: The resource type of the managed HSM Pool.
    types:
    - uid: string
  - name: location
    description: The supported Azure location where the managed HSM Pool should be created.
    types:
    - uid: string
  - name: sku
    description: SKU details
    types:
    - uid: ManagedHsmSku
  - name: tags
    description: Resource tags
    types:
    - uid: object
      isDictionary: true
      additionalTypes:
      - uid: string
      - uid: string
  - name: systemData
    isReadyOnly: true
    description: Metadata pertaining to creation and last modification of the key vault resource.
    types:
    - uid: SystemData
- name: ManagedHsmError
  description: The error exception.
  kind: object
  properties:
  - name: error
    isReadyOnly: true
    description: The server error.
    types:
    - uid: Error
- name: CreateMode
  description: The create mode to indicate whether the resource is being created or is being recovered from a deleted resource.
  kind: enum
  properties:
  - name: recover
    description: Recover the managed HSM pool from a soft-deleted resource.
    types:
    - uid: string
  - name: default
    description: Create a new managed HSM pool. This is the default option.
    types:
    - uid: string
- name: ProvisioningState
  description: Provisioning state.
  kind: enum
  properties:
  - name: Succeeded
    description: The managed HSM Pool has been full provisioned.
    types:
    - uid: string
  - name: Provisioning
    description: The managed HSM Pool is currently being provisioned.
    types:
    - uid: string
  - name: Failed
    description: Provisioning of the managed HSM Pool has failed.
    types:
    - uid: string
  - name: Updating
    description: The managed HSM Pool is currently being updated.
    types:
    - uid: string
  - name: Deleting
    description: The managed HSM Pool is currently being deleted.
    types:
    - uid: string
  - name: Activated
    description: The managed HSM pool is ready for normal use.
    types:
    - uid: string
  - name: SecurityDomainRestore
    description: The managed HSM pool is waiting for a security domain restore action.
    types:
    - uid: string
  - name: Restoring
    description: The managed HSM pool is being restored from full HSM backup.
    types:
    - uid: string
- name: MHSMNetworkRuleSet
  description: A set of rules governing the network accessibility of a managed hsm pool.
  kind: object
  properties:
  - name: bypass
    description: Tells what traffic can bypass network rules. This can be 'AzureServices' or 'None'.  If not specified the default is 'AzureServices'.
    types:
    - uid: NetworkRuleBypassOptions
  - name: defaultAction
    description: The default action when no rule from ipRules and from virtualNetworkRules match. This is only used after the bypass property has been evaluated.
    types:
    - uid: NetworkRuleAction
  - name: ipRules
    description: The list of IP address rules.
    types:
    - uid: MHSMIPRule
      isArray: true
  - name: virtualNetworkRules
    description: The list of virtual network rules.
    types:
    - uid: MHSMVirtualNetworkRule
      isArray: true
- name: MHSMPrivateEndpointConnectionItem
  description: Private endpoint connection item.
  kind: object
  properties:
  - name: id
    description: Id of private endpoint connection.
    types:
    - uid: string
  - name: etag
    description: Modified whenever there is a change in the state of private endpoint connection.
    types:
    - uid: string
  - name: properties.privateEndpoint
    description: Properties of the private endpoint object.
    types:
    - uid: MHSMPrivateEndpoint
  - name: properties.privateLinkServiceConnectionState
    description: Approval state of the private link connection.
    types:
    - uid: MHSMPrivateLinkServiceConnectionState
  - name: properties.provisioningState
    isReadyOnly: true
    description: Provisioning state of the private endpoint connection.
    types:
    - uid: PrivateEndpointConnectionProvisioningState
- name: PublicNetworkAccess
  description: Control permission for data plane traffic coming from public networks while private endpoint is enabled.
  kind: enum
  properties:
  - name: Enabled
    types:
    - uid: string
  - name: Disabled
    types:
    - uid: string
- name: ManagedHsmSkuFamily
  description: SKU Family of the managed HSM Pool
  kind: enum
  properties:
  - name: B
    types:
    - uid: string
- name: ManagedHsmSkuName
  description: SKU of the managed HSM Pool
  kind: enum
  properties:
  - name: Standard_B1
    types:
    - uid: string
  - name: Custom_B32
    types:
    - uid: string
- name: identityType
  description: The type of identity that created the key vault resource.
  kind: enum
  properties:
  - name: User
    types:
    - uid: string
  - name: Application
    types:
    - uid: string
  - name: ManagedIdentity
    types:
    - uid: string
  - name: Key
    types:
    - uid: string
- name: Error
  description: The server error.
  kind: object
  properties:
  - name: code
    isReadyOnly: true
    description: The error code.
    types:
    - uid: string
  - name: message
    isReadyOnly: true
    description: The error message.
    types:
    - uid: string
  - name: innererror
    isReadyOnly: true
    description: The inner error, contains a more specific error code.
    types:
    - uid: Error
- name: NetworkRuleBypassOptions
  description: Tells what traffic can bypass network rules. This can be 'AzureServices' or 'None'.  If not specified the default is 'AzureServices'.
  kind: enum
  properties:
  - name: AzureServices
    types:
    - uid: string
  - name: None
    types:
    - uid: string
- name: NetworkRuleAction
  description: The default action when no rule from ipRules and from virtualNetworkRules match. This is only used after the bypass property has been evaluated.
  kind: enum
  properties:
  - name: Allow
    types:
    - uid: string
  - name: Deny
    types:
    - uid: string
- name: MHSMIPRule
  description: A rule governing the accessibility of a managed hsm pool from a specific ip address or ip range.
  kind: object
  properties:
  - name: value
    description: An IPv4 address range in CIDR notation, such as '124.56.78.91' (simple IP address) or '124.56.78.0/24' (all addresses that start with 124.56.78).
    types:
    - uid: string
- name: MHSMVirtualNetworkRule
  description: A rule governing the accessibility of a managed hsm pool from a specific virtual network.
  kind: object
  properties:
  - name: id
    description: Full resource id of a vnet subnet, such as '/subscriptions/subid/resourceGroups/rg1/providers/Microsoft.Network/virtualNetworks/test-vnet/subnets/subnet1'.
    types:
    - uid: string
- name: MHSMPrivateEndpoint
  description: Private endpoint object properties.
  kind: object
  properties:
  - name: id
    isReadyOnly: true
    description: Full identifier of the private endpoint resource.
    types:
    - uid: string
- name: MHSMPrivateLinkServiceConnectionState
  description: An object that represents the approval state of the private link connection.
  kind: object
  properties:
  - name: status
    description: Indicates whether the connection has been approved, rejected or removed by the key vault owner.
    types:
    - uid: PrivateEndpointServiceConnectionStatus
  - name: description
    description: The reason for approval or rejection.
    types:
    - uid: string
  - name: actionsRequired
    description: A message indicating if changes on the service provider require any updates on the consumer.
    types:
    - uid: ActionsRequired
- name: PrivateEndpointConnectionProvisioningState
  description: Provisioning state of the private endpoint connection.
  kind: enum
  properties:
  - name: Succeeded
    types:
    - uid: string
  - name: Creating
    types:
    - uid: string
  - name: Updating
    types:
    - uid: string
  - name: Deleting
    types:
    - uid: string
  - name: Failed
    types:
    - uid: string
  - name: Disconnected
    types:
    - uid: string
- name: PrivateEndpointServiceConnectionStatus
  description: Indicates whether the connection has been approved, rejected or removed by the key vault owner.
  kind: enum
  properties:
  - name: Pending
    types:
    - uid: string
  - name: Approved
    types:
    - uid: string
  - name: Rejected
    types:
    - uid: string
  - name: Disconnected
    types:
    - uid: string
- name: ActionsRequired
  description: A message indicating if changes on the service provider require any updates on the consumer.
  kind: enum
  properties:
  - name: None
    types:
    - uid: string
examples:
- name: Create a new managed HSM Pool or update an existing managed HSM Pool
  request:
    uri: PUT https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/hsm-group/providers/Microsoft.KeyVault/managedHSMs/hsm1?api-version=2021-10-01
    body: >-
      {
        "properties": {
          "tenantId": "00000000-0000-0000-0000-000000000000",
          "initialAdminObjectIds": [
            "00000000-0000-0000-0000-000000000000"
          ],
          "enableSoftDelete": true,
          "softDeleteRetentionInDays": 90,
          "enablePurgeProtection": true
        },
        "location": "westus",
        "sku": {
          "family": "B",
          "name": "Standard_B1"
        },
        "tags": {
          "Dept": "hsm",
          "Environment": "dogfood"
        }
      }
    codeTab: |+
      # [HTTP](#tab/HTTP)
      ``` http
      PUT https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/hsm-group/providers/Microsoft.KeyVault/managedHSMs/hsm1?api-version=2021-10-01

      {
        "properties": {
          "tenantId": "00000000-0000-0000-0000-000000000000",
          "initialAdminObjectIds": [
            "00000000-0000-0000-0000-000000000000"
          ],
          "enableSoftDelete": true,
          "softDeleteRetentionInDays": 90,
          "enablePurgeProtection": true
        },
        "location": "westus",
        "sku": {
          "family": "B",
          "name": "Standard_B1"
        },
        "tags": {
          "Dept": "hsm",
          "Environment": "dogfood"
        }
      }

      ```

      # [Java](#tab/Java)
      ``` java
      import com.azure.core.util.Context;
      import com.azure.resourcemanager.keyvault.fluent.models.ManagedHsmInner;
      import com.azure.resourcemanager.keyvault.models.ManagedHsmProperties;
      import com.azure.resourcemanager.keyvault.models.ManagedHsmSku;
      import com.azure.resourcemanager.keyvault.models.ManagedHsmSkuFamily;
      import com.azure.resourcemanager.keyvault.models.ManagedHsmSkuName;
      import java.util.Arrays;
      import java.util.HashMap;
      import java.util.Map;
      import java.util.UUID;

      /** Samples for ManagedHsms CreateOrUpdate. */
      public final class Main {
          /*
           * x-ms-original-file: specification/keyvault/resource-manager/Microsoft.KeyVault/stable/2021-10-01/examples/ManagedHsm_CreateOrUpdate.json
           */
          /**
           * Sample code: Create a new managed HSM Pool or update an existing managed HSM Pool.
           *
           * @param azure The entry point for accessing resource management APIs in Azure.
           */
          public static void createANewManagedHSMPoolOrUpdateAnExistingManagedHSMPool(
              com.azure.resourcemanager.AzureResourceManager azure) {
              azure
                  .vaults()
                  .manager()
                  .serviceClient()
                  .getManagedHsms()
                  .createOrUpdate(
                      "hsm-group",
                      "hsm1",
                      new ManagedHsmInner()
                          .withLocation("westus")
                          .withTags(mapOf("Dept", "hsm", "Environment", "dogfood"))
                          .withSku(
                              new ManagedHsmSku().withFamily(ManagedHsmSkuFamily.B).withName(ManagedHsmSkuName.STANDARD_B1))
                          .withProperties(
                              new ManagedHsmProperties()
                                  .withTenantId(UUID.fromString("00000000-0000-0000-0000-000000000000"))
                                  .withInitialAdminObjectIds(Arrays.asList("00000000-0000-0000-0000-000000000000"))
                                  .withEnableSoftDelete(true)
                                  .withSoftDeleteRetentionInDays(90)
                                  .withEnablePurgeProtection(true)),
                      Context.NONE);
          }

          @SuppressWarnings("unchecked")
          private static <T> Map<String, T> mapOf(Object... inputs) {
              Map<String, T> map = new HashMap<>();
              for (int i = 0; i < inputs.length; i += 2) {
                  String key = (String) inputs[i];
                  T value = (T) inputs[i + 1];
                  map.put(key, value);
              }
              return map;
          }
      }

      ```
      Read this [SDK documentation](https://github.com/Azure/azure-sdk-for-java/blob/azure-resourcemanager_2.18.0/sdk/resourcemanager/azure-resourcemanager/README.md) on how to add the SDK to your project and authenticate.
      # [Go](#tab/Go)
      ``` go
      package armkeyvault_test

      import (
      	"context"
      	"log"

      	"github.com/Azure/azure-sdk-for-go/sdk/azcore/to"
      	"github.com/Azure/azure-sdk-for-go/sdk/azidentity"
      	"github.com/Azure/azure-sdk-for-go/sdk/resourcemanager/keyvault/armkeyvault"
      )

      // Generated from example definition: https://github.com/Azure/azure-rest-api-specs/tree/main/specification/keyvault/resource-manager/Microsoft.KeyVault/stable/2021-10-01/examples/ManagedHsm_CreateOrUpdate.json
      func ExampleManagedHsmsClient_BeginCreateOrUpdate() {
      	cred, err := azidentity.NewDefaultAzureCredential(nil)
      	if err != nil {
      		log.Fatalf("failed to obtain a credential: %v", err)
      	}
      	ctx := context.Background()
      	client, err := armkeyvault.NewManagedHsmsClient("00000000-0000-0000-0000-000000000000", cred, nil)
      	if err != nil {
      		log.Fatalf("failed to create client: %v", err)
      	}
      	poller, err := client.BeginCreateOrUpdate(ctx,
      		"hsm-group",
      		"hsm1",
      		armkeyvault.ManagedHsm{
      			Location: to.Ptr("westus"),
      			SKU: &armkeyvault.ManagedHsmSKU{
      				Name:   to.Ptr(armkeyvault.ManagedHsmSKUNameStandardB1),
      				Family: to.Ptr(armkeyvault.ManagedHsmSKUFamilyB),
      			},
      			Tags: map[string]*string{
      				"Dept":        to.Ptr("hsm"),
      				"Environment": to.Ptr("dogfood"),
      			},
      			Properties: &armkeyvault.ManagedHsmProperties{
      				EnablePurgeProtection: to.Ptr(true),
      				EnableSoftDelete:      to.Ptr(true),
      				InitialAdminObjectIDs: []*string{
      					to.Ptr("00000000-0000-0000-0000-000000000000")},
      				SoftDeleteRetentionInDays: to.Ptr[int32](90),
      				TenantID:                  to.Ptr("00000000-0000-0000-0000-000000000000"),
      			},
      		},
      		nil)
      	if err != nil {
      		log.Fatalf("failed to finish the request: %v", err)
      	}
      	res, err := poller.PollUntilDone(ctx, nil)
      	if err != nil {
      		log.Fatalf("failed to pull the result: %v", err)
      	}
      	// TODO: use response item
      	_ = res
      }

      ```
      Read this [SDK documentation](https://github.com/Azure/azure-sdk-for-go/blob/sdk%2Fresourcemanager%2Fkeyvault%2Farmkeyvault%2Fv1.0.0/sdk/resourcemanager/keyvault/armkeyvault/README.md) on how to add the SDK to your project and authenticate.
  responses:
  - statusCode: "202"
    body: >-
      {
        "properties": {
          "tenantId": "00000000-0000-0000-0000-000000000000",
          "initialAdminObjectIds": [
            "00000000-0000-0000-0000-000000000000"
          ],
          "enableSoftDelete": true,
          "softDeleteRetentionInDays": 90,
          "enablePurgeProtection": true,
          "hsmUri": null,
          "provisioningState": "Provisioning",
          "statusMessage": "Allocating hardware"
        },
        "id": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/hsm-group/providers/Microsoft.KeyVault/managedHSMs/hsm1",
        "name": "hsm1",
        "type": "Microsoft.KeyVault/managedHSMs",
        "location": "westus",
        "sku": {
          "family": "B",
          "name": "Standard_B1"
        },
        "tags": {
          "Dept": "hsm",
          "Environment": "dogfood"
        }
      }
  - statusCode: "200"
    body: >-
      {
        "properties": {
          "tenantId": "00000000-0000-0000-0000-000000000000",
          "initialAdminObjectIds": [
            "00000000-0000-0000-0000-000000000000"
          ],
          "enableSoftDelete": true,
          "softDeleteRetentionInDays": 90,
          "enablePurgeProtection": true,
          "hsmUri": "https://westus.hsm1.managedhsm.azure.net",
          "provisioningState": "Succeeded",
          "statusMessage": "ManagedHsm is functional."
        },
        "id": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/hsm-group/providers/Microsoft.KeyVault/managedHSMs/hsm1",
        "name": "hsm1",
        "type": "Microsoft.KeyVault/managedHSMs",
        "location": "westus",
        "sku": {
          "family": "B",
          "name": "Standard_B1"
        },
        "tags": {
          "Dept": "hsm",
          "Environment": "dogfood"
        }
      }
security:
- name: azure_auth
  type: oauth2
  description: Azure Active Directory OAuth2 Flow
  flow: implicit
  authorizationUrl: https://login.microsoftonline.com/common/oauth2/authorize
  scopes:
  - name: user_impersonation
    description: impersonate your user account
metadata:
  description: >
    Learn more about Key Vault service - Create or update a managed HSM Pool in the specified subscription.
errorCodes: []
