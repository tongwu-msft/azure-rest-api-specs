### YamlMime:RESTOperation
uid: management.azure.com.network-watcher.packetcaptures.create
name: Create
service: Network Watcher
groupName: Packet Captures
apiVersion: 2022-01-01
summary: Create and start a packet capture on the specified VM.
consumes:
- application/json
produces:
- application/json
paths:
- content: PUT https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Network/networkWatchers/{networkWatcherName}/packetCaptures/{packetCaptureName}?api-version=2022-01-01
uriParameters:
- name: subscriptionId
  in: path
  isRequired: true
  description: The subscription credentials which uniquely identify the Microsoft Azure subscription. The subscription ID forms part of the URI for every service call.
  types:
  - uid: string
- name: resourceGroupName
  in: path
  isRequired: true
  description: The name of the resource group.
  types:
  - uid: string
- name: networkWatcherName
  in: path
  isRequired: true
  description: The name of the network watcher.
  types:
  - uid: string
- name: packetCaptureName
  in: path
  isRequired: true
  description: The name of the packet capture session.
  types:
  - uid: string
- name: api-version
  in: query
  isRequired: true
  description: Client API version.
  types:
  - uid: string
responses:
- name: 201 Created
  description: Request successful. The operation returns the resulting packet capture session.
  types:
  - uid: PacketCaptureResult
- name: Other Status Codes
  description: Error response describing why the operation failed.
  types:
  - uid: ErrorResponse
requestBody:
- name: default
  parameters:
  - name: properties.target
    in: body
    isRequired: true
    description: The ID of the targeted resource, only AzureVM and AzureVMSS as target type are currently supported.
    types:
    - uid: string
  - name: properties.scope
    in: body
    description: A list of AzureVMSS instances which can be included or excluded to run packet capture. If both included and excluded are empty, then the packet capture will run on all instances of AzureVMSS.
    types:
    - uid: PacketCaptureMachineScope
  - name: properties.targetType
    in: body
    description: Target type of the resource provided.
    types:
    - uid: PacketCaptureTargetType
  - name: properties.bytesToCapturePerPacket
    in: body
    description: Number of bytes captured per packet, the remaining bytes are truncated.
    types:
    - uid: integer
  - name: properties.totalBytesPerSession
    in: body
    description: Maximum size of the capture output.
    types:
    - uid: integer
  - name: properties.timeLimitInSeconds
    in: body
    description: Maximum duration of the capture session in seconds.
    types:
    - uid: integer
  - name: properties.storageLocation
    in: body
    isRequired: true
    description: The storage location for a packet capture session.
    types:
    - uid: PacketCaptureStorageLocation
  - name: properties.filters
    in: body
    description: A list of packet capture filters.
    types:
    - uid: PacketCaptureFilter
      isArray: true
requestHeader: []
definitions:
- name: PacketCaptureMachineScope
  description: A list of AzureVMSS instances which can be included or excluded to run packet capture. If both included and excluded are empty, then the packet capture will run on all instances of AzureVMSS.
  kind: object
  properties:
  - name: include
    description: List of AzureVMSS instances to run packet capture on.
    types:
    - uid: string
      isArray: true
  - name: exclude
    description: List of AzureVMSS instances which has to be excluded from the AzureVMSS from running packet capture.
    types:
    - uid: string
      isArray: true
- name: PacketCaptureStorageLocation
  description: The storage location for a packet capture session.
  kind: object
  properties:
  - name: storageId
    description: The ID of the storage account to save the packet capture session. Required if no local file path is provided.
    types:
    - uid: string
  - name: storagePath
    description: The URI of the storage path to save the packet capture. Must be a well-formed URI describing the location to save the packet capture.
    types:
    - uid: string
  - name: filePath
    description: A valid local path on the targeting VM. Must include the name of the capture file (*.cap). For linux virtual machine it must start with /var/captures. Required if no storage ID is provided, otherwise optional.
    types:
    - uid: string
- name: PacketCaptureFilter
  description: Filter that is applied to packet capture request. Multiple filters can be applied.
  kind: object
  properties:
  - name: protocol
    description: Protocol to be filtered on.
    types:
    - uid: PcProtocol
    defaultValue: Any
  - name: localIPAddress
    description: 'Local IP Address to be filtered on. Notation: "127.0.0.1" for single address entry. "127.0.0.1-127.0.0.255" for range. "127.0.0.1;127.0.0.5"? for multiple entries. Multiple ranges not currently supported. Mixing ranges with multiple entries not currently supported. Default = null.'
    types:
    - uid: string
  - name: remoteIPAddress
    description: 'Local IP Address to be filtered on. Notation: "127.0.0.1" for single address entry. "127.0.0.1-127.0.0.255" for range. "127.0.0.1;127.0.0.5;" for multiple entries. Multiple ranges not currently supported. Mixing ranges with multiple entries not currently supported. Default = null.'
    types:
    - uid: string
  - name: localPort
    description: 'Local port to be filtered on. Notation: "80" for single port entry."80-85" for range. "80;443;" for multiple entries. Multiple ranges not currently supported. Mixing ranges with multiple entries not currently supported. Default = null.'
    types:
    - uid: string
  - name: remotePort
    description: 'Remote port to be filtered on. Notation: "80" for single port entry."80-85" for range. "80;443;" for multiple entries. Multiple ranges not currently supported. Mixing ranges with multiple entries not currently supported. Default = null.'
    types:
    - uid: string
- name: PacketCaptureResult
  description: Information about packet capture session.
  kind: object
  properties:
  - name: name
    isReadyOnly: true
    description: Name of the packet capture session.
    types:
    - uid: string
  - name: id
    isReadyOnly: true
    description: ID of the packet capture operation.
    types:
    - uid: string
  - name: etag
    isReadyOnly: true
    description: A unique read-only string that changes whenever the resource is updated.
    types:
    - uid: string
  - name: properties.provisioningState
    isReadyOnly: true
    description: The provisioning state of the packet capture session.
    types:
    - uid: ProvisioningState
  - name: properties.target
    description: The ID of the targeted resource, only AzureVM and AzureVMSS as target type are currently supported.
    types:
    - uid: string
  - name: properties.scope
    description: A list of AzureVMSS instances which can be included or excluded to run packet capture. If both included and excluded are empty, then the packet capture will run on all instances of AzureVMSS.
    types:
    - uid: PacketCaptureMachineScope
  - name: properties.targetType
    description: Target type of the resource provided.
    types:
    - uid: PacketCaptureTargetType
  - name: properties.bytesToCapturePerPacket
    description: Number of bytes captured per packet, the remaining bytes are truncated.
    types:
    - uid: integer
    defaultValue: 0
  - name: properties.totalBytesPerSession
    description: Maximum size of the capture output.
    types:
    - uid: integer
    defaultValue: 1073741824
  - name: properties.timeLimitInSeconds
    description: Maximum duration of the capture session in seconds.
    types:
    - uid: integer
    defaultValue: 18000
  - name: properties.storageLocation
    description: The storage location for a packet capture session.
    types:
    - uid: PacketCaptureStorageLocation
  - name: properties.filters
    description: A list of packet capture filters.
    types:
    - uid: PacketCaptureFilter
      isArray: true
- name: ErrorResponse
  description: The error object.
  kind: object
  properties:
  - name: error
    description: "Error  \nThe error details object."
    types:
    - uid: ErrorDetails
- name: PacketCapture
  description: Parameters that define the create packet capture operation.
  kind: object
  properties:
  - name: properties.target
    description: The ID of the targeted resource, only AzureVM and AzureVMSS as target type are currently supported.
    types:
    - uid: string
  - name: properties.scope
    description: A list of AzureVMSS instances which can be included or excluded to run packet capture. If both included and excluded are empty, then the packet capture will run on all instances of AzureVMSS.
    types:
    - uid: PacketCaptureMachineScope
  - name: properties.targetType
    description: Target type of the resource provided.
    types:
    - uid: PacketCaptureTargetType
  - name: properties.bytesToCapturePerPacket
    description: Number of bytes captured per packet, the remaining bytes are truncated.
    types:
    - uid: integer
    defaultValue: 0
  - name: properties.totalBytesPerSession
    description: Maximum size of the capture output.
    types:
    - uid: integer
    defaultValue: 1073741824
  - name: properties.timeLimitInSeconds
    description: Maximum duration of the capture session in seconds.
    types:
    - uid: integer
    defaultValue: 18000
  - name: properties.storageLocation
    description: The storage location for a packet capture session.
    types:
    - uid: PacketCaptureStorageLocation
  - name: properties.filters
    description: A list of packet capture filters.
    types:
    - uid: PacketCaptureFilter
      isArray: true
- name: PcProtocol
  description: Protocol to be filtered on.
  kind: enum
  properties:
  - name: TCP
    types:
    - uid: string
  - name: UDP
    types:
    - uid: string
  - name: Any
    types:
    - uid: string
- name: ProvisioningState
  description: The current provisioning state.
  kind: enum
  properties:
  - name: Succeeded
    types:
    - uid: string
  - name: Updating
    types:
    - uid: string
  - name: Deleting
    types:
    - uid: string
  - name: Failed
    types:
    - uid: string
- name: PacketCaptureTargetType
  description: Target type of the resource provided.
  kind: enum
  properties:
  - name: AzureVM
    types:
    - uid: string
  - name: AzureVMSS
    types:
    - uid: string
- name: ErrorDetails
  description: Common error details representation.
  kind: object
  properties:
  - name: code
    description: Error code.
    types:
    - uid: string
  - name: target
    description: Error target.
    types:
    - uid: string
  - name: message
    description: Error message.
    types:
    - uid: string
examples:
- name: Create packet capture
  request:
    uri: PUT https://management.azure.com/subscriptions/subid/resourceGroups/rg1/providers/Microsoft.Network/networkWatchers/nw1/packetCaptures/pc1?api-version=2022-01-01
    body: >-
      {
        "properties": {
          "target": "/subscriptions/subid/resourceGroups/rg2/providers/Microsoft.Compute/virtualMachines/vm1",
          "bytesToCapturePerPacket": 10000,
          "totalBytesPerSession": 100000,
          "timeLimitInSeconds": 100,
          "storageLocation": {
            "storageId": "/subscriptions/subid/resourceGroups/rg2/providers/Microsoft.Storage/storageAccounts/pcstore",
            "storagePath": "https://mytestaccountname.blob.core.windows.net/capture/pc1.cap",
            "filePath": "D:\\capture\\pc1.cap"
          },
          "filters": [
            {
              "protocol": "TCP",
              "localIPAddress": "10.0.0.4",
              "localPort": "80"
            }
          ]
        }
      }
    codeTab: |+
      # [HTTP](#tab/HTTP)
      ``` http
      PUT https://management.azure.com/subscriptions/subid/resourceGroups/rg1/providers/Microsoft.Network/networkWatchers/nw1/packetCaptures/pc1?api-version=2022-01-01

      {
        "properties": {
          "target": "/subscriptions/subid/resourceGroups/rg2/providers/Microsoft.Compute/virtualMachines/vm1",
          "bytesToCapturePerPacket": 10000,
          "totalBytesPerSession": 100000,
          "timeLimitInSeconds": 100,
          "storageLocation": {
            "storageId": "/subscriptions/subid/resourceGroups/rg2/providers/Microsoft.Storage/storageAccounts/pcstore",
            "storagePath": "https://mytestaccountname.blob.core.windows.net/capture/pc1.cap",
            "filePath": "D:\\capture\\pc1.cap"
          },
          "filters": [
            {
              "protocol": "TCP",
              "localIPAddress": "10.0.0.4",
              "localPort": "80"
            }
          ]
        }
      }

      ```

      # [Java](#tab/Java)
      ``` java
      import com.azure.core.util.Context;
      import com.azure.resourcemanager.network.fluent.models.PacketCaptureInner;
      import com.azure.resourcemanager.network.models.PacketCaptureFilter;
      import com.azure.resourcemanager.network.models.PacketCaptureStorageLocation;
      import com.azure.resourcemanager.network.models.PcProtocol;
      import java.util.Arrays;

      /** Samples for PacketCaptures Create. */
      public final class Main {
          /*
           * x-ms-original-file: specification/network/resource-manager/Microsoft.Network/stable/2022-01-01/examples/NetworkWatcherPacketCaptureCreate.json
           */
          /**
           * Sample code: Create packet capture.
           *
           * @param azure The entry point for accessing resource management APIs in Azure.
           */
          public static void createPacketCapture(com.azure.resourcemanager.AzureResourceManager azure) {
              azure
                  .networks()
                  .manager()
                  .serviceClient()
                  .getPacketCaptures()
                  .create(
                      "rg1",
                      "nw1",
                      "pc1",
                      new PacketCaptureInner()
                          .withTarget(
                              "/subscriptions/subid/resourceGroups/rg2/providers/Microsoft.Compute/virtualMachines/vm1")
                          .withBytesToCapturePerPacket(10000L)
                          .withTotalBytesPerSession(100000L)
                          .withTimeLimitInSeconds(100)
                          .withStorageLocation(
                              new PacketCaptureStorageLocation()
                                  .withStorageId(
                                      "/subscriptions/subid/resourceGroups/rg2/providers/Microsoft.Storage/storageAccounts/pcstore")
                                  .withStoragePath("https://mytestaccountname.blob.core.windows.net/capture/pc1.cap")
                                  .withFilePath("D:\\capture\\pc1.cap"))
                          .withFilters(
                              Arrays
                                  .asList(
                                      new PacketCaptureFilter()
                                          .withProtocol(PcProtocol.TCP)
                                          .withLocalIpAddress("10.0.0.4")
                                          .withLocalPort("80"))),
                      Context.NONE);
          }
      }

      ```
      Read this [SDK documentation](https://github.com/Azure/azure-sdk-for-java/blob/azure-resourcemanager_2.18.0/sdk/resourcemanager/azure-resourcemanager/README.md) on how to add the SDK to your project and authenticate.
      # [Go](#tab/Go)
      ``` go
      package armnetwork_test

      import (
      	"context"
      	"log"

      	"github.com/Azure/azure-sdk-for-go/sdk/azcore/to"
      	"github.com/Azure/azure-sdk-for-go/sdk/azidentity"
      	"github.com/Azure/azure-sdk-for-go/sdk/resourcemanager/network/armnetwork"
      )

      // Generated from example definition: https://github.com/Azure/azure-rest-api-specs/tree/main/specification/network/resource-manager/Microsoft.Network/stable/2022-01-01/examples/NetworkWatcherPacketCaptureCreate.json
      func ExamplePacketCapturesClient_BeginCreate() {
      	cred, err := azidentity.NewDefaultAzureCredential(nil)
      	if err != nil {
      		log.Fatalf("failed to obtain a credential: %v", err)
      	}
      	ctx := context.Background()
      	client, err := armnetwork.NewPacketCapturesClient("subid", cred, nil)
      	if err != nil {
      		log.Fatalf("failed to create client: %v", err)
      	}
      	poller, err := client.BeginCreate(ctx, "rg1", "nw1", "pc1", armnetwork.PacketCapture{
      		Properties: &armnetwork.PacketCaptureParameters{
      			BytesToCapturePerPacket: to.Ptr[int64](10000),
      			Filters: []*armnetwork.PacketCaptureFilter{
      				{
      					LocalIPAddress: to.Ptr("10.0.0.4"),
      					LocalPort:      to.Ptr("80"),
      					Protocol:       to.Ptr(armnetwork.PcProtocolTCP),
      				}},
      			StorageLocation: &armnetwork.PacketCaptureStorageLocation{
      				FilePath:    to.Ptr("D:\\capture\\pc1.cap"),
      				StorageID:   to.Ptr("/subscriptions/subid/resourceGroups/rg2/providers/Microsoft.Storage/storageAccounts/pcstore"),
      				StoragePath: to.Ptr("https://mytestaccountname.blob.core.windows.net/capture/pc1.cap"),
      			},
      			Target:               to.Ptr("/subscriptions/subid/resourceGroups/rg2/providers/Microsoft.Compute/virtualMachines/vm1"),
      			TimeLimitInSeconds:   to.Ptr[int32](100),
      			TotalBytesPerSession: to.Ptr[int64](100000),
      		},
      	}, nil)
      	if err != nil {
      		log.Fatalf("failed to finish the request: %v", err)
      	}
      	_, err = poller.PollUntilDone(ctx, nil)
      	if err != nil {
      		log.Fatalf("failed to pull the result: %v", err)
      	}
      }

      ```
      Read this [SDK documentation](https://github.com/Azure/azure-sdk-for-go/blob/sdk%2Fresourcemanager%2Fnetwork%2Farmnetwork%2Fv1.1.0/sdk/resourcemanager/network/armnetwork/README.md) on how to add the SDK to your project and authenticate.
      # [JavaScript](#tab/JavaScript)
      ``` js
      const { NetworkManagementClient } = require("@azure/arm-network");
      const { DefaultAzureCredential } = require("@azure/identity");

      /**
       * This sample demonstrates how to Create and start a packet capture on the specified VM.
       *
       * @summary Create and start a packet capture on the specified VM.
       * x-ms-original-file: specification/network/resource-manager/Microsoft.Network/stable/2022-01-01/examples/NetworkWatcherPacketCaptureCreate.json
       */
      async function createPacketCapture() {
        const subscriptionId = "subid";
        const resourceGroupName = "rg1";
        const networkWatcherName = "nw1";
        const packetCaptureName = "pc1";
        const parameters = {
          bytesToCapturePerPacket: 10000,
          filters: [{ localIPAddress: "10.0.0.4", localPort: "80", protocol: "TCP" }],
          storageLocation: {
            filePath: "D:capturepc1.cap",
            storageId:
              "/subscriptions/subid/resourceGroups/rg2/providers/Microsoft.Storage/storageAccounts/pcstore",
            storagePath: "https://mytestaccountname.blob.core.windows.net/capture/pc1.cap",
          },
          target:
            "/subscriptions/subid/resourceGroups/rg2/providers/Microsoft.Compute/virtualMachines/vm1",
          timeLimitInSeconds: 100,
          totalBytesPerSession: 100000,
        };
        const credential = new DefaultAzureCredential();
        const client = new NetworkManagementClient(credential, subscriptionId);
        const result = await client.packetCaptures.beginCreateAndWait(
          resourceGroupName,
          networkWatcherName,
          packetCaptureName,
          parameters
        );
        console.log(result);
      }

      createPacketCapture().catch(console.error);

      ```
      Read this [SDK documentation](https://github.com/Azure/azure-sdk-for-js/blob/%40azure%2Farm-network_29.0.0/sdk/network/arm-network/README.md) on how to add the SDK to your project and authenticate.
  responses:
  - statusCode: "201"
    body: >-
      {
        "name": "pc1",
        "id": "/subscriptions/subid/resourceGroups/rg1/providers/Microsoft.Network/networkWatchers/nw1/packetCaptures/pc1",
        "properties": {
          "provisioningState": "Updating",
          "target": "/subscriptions/subid/resourceGroups/rg2/providers/Microsoft.Compute/virtualMachines/vm1",
          "bytesToCapturePerPacket": 10000,
          "totalBytesPerSession": 100000,
          "timeLimitInSeconds": 100,
          "storageLocation": {
            "storageId": "/subscriptions/subid/resourceGroups/rg2/providers/Microsoft.Storage/storageAccounts/pcstore",
            "storagePath": "https://mytestaccountname.blob.core.windows.net/capture/pc1.cap",
            "filePath": "D:\\capture\\pc1.cap"
          },
          "filters": [
            {
              "protocol": "TCP",
              "localIPAddress": "10.0.0.4",
              "localPort": "80"
            }
          ]
        }
      }
security:
- name: azure_auth
  type: oauth2
  description: Azure Active Directory OAuth2 Flow.
  flow: implicit
  authorizationUrl: https://login.microsoftonline.com/common/oauth2/authorize
  scopes:
  - name: user_impersonation
    description: impersonate your user account
metadata:
  description: >
    Learn more about Network Watcher service - Create and start a packet capture on the specified VM.
errorCodes: []
