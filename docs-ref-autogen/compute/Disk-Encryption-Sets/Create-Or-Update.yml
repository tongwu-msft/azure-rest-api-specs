### YamlMime:RESTOperation
uid: management.azure.com.compute.diskencryptionsets.createorupdate
name: Create Or Update
service: Compute
groupName: Disk Encryption Sets
apiVersion: 2021-12-01
summary: Creates or updates a disk encryption set
consumes:
- application/json
produces:
- application/json
paths:
- content: PUT https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/diskEncryptionSets/{diskEncryptionSetName}?api-version=2021-12-01
uriParameters:
- name: subscriptionId
  in: path
  isRequired: true
  description: Subscription credentials which uniquely identify Microsoft Azure subscription. The subscription ID forms part of the URI for every service call.
  types:
  - uid: string
- name: resourceGroupName
  in: path
  isRequired: true
  description: The name of the resource group.
  types:
  - uid: string
- name: diskEncryptionSetName
  in: path
  isRequired: true
  description: The name of the disk encryption set that is being created. The name can't be changed after the disk encryption set is created. Supported characters for the name are a-z, A-Z, 0-9, _ and -. The maximum name length is 80 characters.
  types:
  - uid: string
- name: api-version
  in: query
  isRequired: true
  description: Client Api Version.
  types:
  - uid: string
responses:
- name: 200 OK
  description: OK
  types:
  - uid: DiskEncryptionSet
- name: 202 Accepted
  description: Accepted
  types:
  - uid: DiskEncryptionSet
- name: Other Status Codes
  description: Error response describing why the operation failed.
  types:
  - uid: CloudError
requestBody:
- name: default
  parameters:
  - name: identity
    in: body
    description: The managed identity for the disk encryption set. It should be given permission on the key vault before it can be used to encrypt disks.
    types:
    - uid: EncryptionSetIdentity
  - name: properties.encryptionType
    in: body
    description: The type of key used to encrypt the data of the disk.
    types:
    - uid: DiskEncryptionSetType
  - name: properties.activeKey
    in: body
    description: The key vault key which is currently used by this disk encryption set.
    types:
    - uid: KeyForDiskEncryptionSet
  - name: properties.rotationToLatestKeyVersionEnabled
    in: body
    description: Set this flag to true to enable auto-updating of this disk encryption set to the latest key version.
    types:
    - uid: boolean
  - name: location
    in: body
    isRequired: true
    description: Resource location
    types:
    - uid: string
  - name: tags
    in: body
    description: Resource tags
    types:
    - uid: object
      isDictionary: true
      additionalTypes:
      - uid: string
      - uid: string
requestHeader: []
definitions:
- name: EncryptionSetIdentity
  description: The managed identity for the disk encryption set. It should be given permission on the key vault before it can be used to encrypt disks.
  kind: object
  properties:
  - name: type
    description: The type of Managed Identity used by the DiskEncryptionSet. Only SystemAssigned is supported for new creations. Disk Encryption Sets can be updated with Identity type None during migration of subscription to a new Azure Active Directory tenant; it will cause the encrypted resources to lose access to the keys.
    types:
    - uid: DiskEncryptionSetIdentityType
  - name: principalId
    isReadyOnly: true
    description: The object id of the Managed Identity Resource. This will be sent to the RP from ARM via the x-ms-identity-principal-id header in the PUT request if the resource has a systemAssigned(implicit) identity
    types:
    - uid: string
  - name: tenantId
    isReadyOnly: true
    description: The tenant id of the Managed Identity Resource. This will be sent to the RP from ARM via the x-ms-client-tenant-id header in the PUT request if the resource has a systemAssigned(implicit) identity
    types:
    - uid: string
- name: KeyForDiskEncryptionSet
  description: Key Vault Key Url to be used for server side encryption of Managed Disks and Snapshots
  kind: object
  properties:
  - name: sourceVault
    description: Resource id of the KeyVault containing the key or secret. This property is optional and cannot be used if the KeyVault subscription is not the same as the Disk Encryption Set subscription.
    types:
    - uid: SourceVault
  - name: keyUrl
    description: Fully versioned Key Url pointing to a key in KeyVault. Version segment of the Url is required regardless of rotationToLatestKeyVersionEnabled value.
    types:
    - uid: string
- name: ApiError
  description: Api error.
  kind: object
  properties:
  - name: details
    description: The Api error details
    types:
    - uid: ApiErrorBase
      isArray: true
  - name: innererror
    description: The Api inner error
    types:
    - uid: InnerError
  - name: code
    description: The error code.
    types:
    - uid: string
  - name: target
    description: The target of the particular error.
    types:
    - uid: string
  - name: message
    description: The error message.
    types:
    - uid: string
- name: DiskEncryptionSet
  description: disk encryption set resource.
  kind: object
  properties:
  - name: identity
    description: The managed identity for the disk encryption set. It should be given permission on the key vault before it can be used to encrypt disks.
    types:
    - uid: EncryptionSetIdentity
  - name: properties.encryptionType
    description: The type of key used to encrypt the data of the disk.
    types:
    - uid: DiskEncryptionSetType
  - name: properties.activeKey
    description: The key vault key which is currently used by this disk encryption set.
    types:
    - uid: KeyForDiskEncryptionSet
  - name: properties.previousKeys
    isReadyOnly: true
    description: A readonly collection of key vault keys previously used by this disk encryption set while a key rotation is in progress. It will be empty if there is no ongoing key rotation.
    types:
    - uid: KeyForDiskEncryptionSet
      isArray: true
  - name: properties.provisioningState
    isReadyOnly: true
    description: The disk encryption set provisioning state.
    types:
    - uid: string
  - name: properties.rotationToLatestKeyVersionEnabled
    description: Set this flag to true to enable auto-updating of this disk encryption set to the latest key version.
    types:
    - uid: boolean
  - name: properties.lastKeyRotationTimestamp
    isReadyOnly: true
    description: The time when the active key of this disk encryption set was updated.
    types:
    - uid: string
  - name: properties.autoKeyRotationError
    isReadyOnly: true
    description: The error that was encountered during auto-key rotation. If an error is present, then auto-key rotation will not be attempted until the error on this disk encryption set is fixed.
    types:
    - uid: ApiError
  - name: id
    isReadyOnly: true
    description: Resource Id
    types:
    - uid: string
  - name: name
    isReadyOnly: true
    description: Resource name
    types:
    - uid: string
  - name: type
    isReadyOnly: true
    description: Resource type
    types:
    - uid: string
  - name: location
    description: Resource location
    types:
    - uid: string
  - name: tags
    description: Resource tags
    types:
    - uid: object
      isDictionary: true
      additionalTypes:
      - uid: string
      - uid: string
- name: CloudError
  description: An error response from the Compute service.
  kind: object
  properties:
  - name: error
    description: Api error.
    types:
    - uid: ApiError
- name: DiskEncryptionSetIdentityType
  description: The type of Managed Identity used by the DiskEncryptionSet. Only SystemAssigned is supported for new creations. Disk Encryption Sets can be updated with Identity type None during migration of subscription to a new Azure Active Directory tenant; it will cause the encrypted resources to lose access to the keys.
  kind: enum
  properties:
  - name: SystemAssigned
    types:
    - uid: string
  - name: None
    types:
    - uid: string
- name: SourceVault
  description: The vault id is an Azure Resource Manager Resource id in the form /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.KeyVault/vaults/{vaultName}
  kind: object
  properties:
  - name: id
    description: Resource Id
    types:
    - uid: string
- name: ApiErrorBase
  description: Api error base.
  kind: object
  properties:
  - name: code
    description: The error code.
    types:
    - uid: string
  - name: target
    description: The target of the particular error.
    types:
    - uid: string
  - name: message
    description: The error message.
    types:
    - uid: string
- name: InnerError
  description: Inner error details.
  kind: object
  properties:
  - name: exceptiontype
    description: The exception type.
    types:
    - uid: string
  - name: errordetail
    description: The internal error message or exception dump.
    types:
    - uid: string
- name: DiskEncryptionSetType
  description: The type of key used to encrypt the data of the disk.
  kind: enum
  properties:
  - name: EncryptionAtRestWithCustomerKey
    description: Resource using diskEncryptionSet would be encrypted at rest with Customer managed key that can be changed and revoked by a customer.
    types:
    - uid: string
  - name: EncryptionAtRestWithPlatformAndCustomerKeys
    description: Resource using diskEncryptionSet would be encrypted at rest with two layers of encryption. One of the keys is Customer managed and the other key is Platform managed.
    types:
    - uid: string
  - name: ConfidentialVmEncryptedWithCustomerKey
    description: Confidential VM supported disk and VM guest state would be encrypted with customer managed key.
    types:
    - uid: string
examples:
- name: Create a disk encryption set.
  request:
    uri: PUT https://management.azure.com/subscriptions/{subscription-id}/resourceGroups/myResourceGroup/providers/Microsoft.Compute/diskEncryptionSets/myDiskEncryptionSet?api-version=2021-12-01
    body: >-
      {
        "location": "West US",
        "identity": {
          "type": "SystemAssigned"
        },
        "properties": {
          "activeKey": {
            "sourceVault": {
              "id": "/subscriptions/{subscriptionId}/resourceGroups/myResourceGroup/providers/Microsoft.KeyVault/vaults/myVMVault"
            },
            "keyUrl": "https://myvmvault.vault-int.azure-int.net/keys/{key}"
          },
          "encryptionType": "EncryptionAtRestWithCustomerKey"
        }
      }
    codeTab: |+
      # [HTTP](#tab/HTTP)
      ``` http
      PUT https://management.azure.com/subscriptions/{subscription-id}/resourceGroups/myResourceGroup/providers/Microsoft.Compute/diskEncryptionSets/myDiskEncryptionSet?api-version=2021-12-01

      {
        "location": "West US",
        "identity": {
          "type": "SystemAssigned"
        },
        "properties": {
          "activeKey": {
            "sourceVault": {
              "id": "/subscriptions/{subscriptionId}/resourceGroups/myResourceGroup/providers/Microsoft.KeyVault/vaults/myVMVault"
            },
            "keyUrl": "https://myvmvault.vault-int.azure-int.net/keys/{key}"
          },
          "encryptionType": "EncryptionAtRestWithCustomerKey"
        }
      }

      ```

      # [Java](#tab/Java)
      ``` java
      import com.azure.core.util.Context;
      import com.azure.resourcemanager.compute.fluent.models.DiskEncryptionSetInner;
      import com.azure.resourcemanager.compute.models.DiskEncryptionSetIdentityType;
      import com.azure.resourcemanager.compute.models.DiskEncryptionSetType;
      import com.azure.resourcemanager.compute.models.EncryptionSetIdentity;
      import com.azure.resourcemanager.compute.models.KeyForDiskEncryptionSet;
      import com.azure.resourcemanager.compute.models.SourceVault;

      /** Samples for DiskEncryptionSets CreateOrUpdate. */
      public final class Main {
          /*
           * x-ms-original-file: specification/compute/resource-manager/Microsoft.Compute/stable/2021-12-01/examples/CreateADiskEncryptionSet.json
           */
          /**
           * Sample code: Create a disk encryption set.
           *
           * @param azure The entry point for accessing resource management APIs in Azure.
           */
          public static void createADiskEncryptionSet(com.azure.resourcemanager.AzureResourceManager azure) {
              azure
                  .virtualMachines()
                  .manager()
                  .serviceClient()
                  .getDiskEncryptionSets()
                  .createOrUpdate(
                      "myResourceGroup",
                      "myDiskEncryptionSet",
                      new DiskEncryptionSetInner()
                          .withLocation("West US")
                          .withIdentity(new EncryptionSetIdentity().withType(DiskEncryptionSetIdentityType.SYSTEM_ASSIGNED))
                          .withEncryptionType(DiskEncryptionSetType.ENCRYPTION_AT_REST_WITH_CUSTOMER_KEY)
                          .withActiveKey(
                              new KeyForDiskEncryptionSet()
                                  .withSourceVault(
                                      new SourceVault()
                                          .withId(
                                              "/subscriptions/{subscriptionId}/resourceGroups/myResourceGroup/providers/Microsoft.KeyVault/vaults/myVMVault"))
                                  .withKeyUrl("https://myvmvault.vault-int.azure-int.net/keys/{key}")),
                      Context.NONE);
          }
      }

      ```
      Read this [SDK documentation](https://github.com/Azure/azure-sdk-for-java/blob/azure-resourcemanager_2.15.0/sdk/resourcemanager/azure-resourcemanager/README.md) on how to add the SDK to your project and authenticate.
      # [JavaScript](#tab/JavaScript)
      ``` js
      const { ComputeManagementClient } = require("@azure/arm-compute");
      const { DefaultAzureCredential } = require("@azure/identity");

      /**
       * This sample demonstrates how to Creates or updates a disk encryption set
       *
       * @summary Creates or updates a disk encryption set
       * x-ms-original-file: specification/compute/resource-manager/Microsoft.Compute/stable/2021-12-01/examples/CreateADiskEncryptionSet.json
       */
      async function createADiskEncryptionSet() {
        const subscriptionId = "{subscription-id}";
        const resourceGroupName = "myResourceGroup";
        const diskEncryptionSetName = "myDiskEncryptionSet";
        const diskEncryptionSet = {
          activeKey: {
            keyUrl: "https://myvmvault.vault-int.azure-int.net/keys/{key}",
            sourceVault: {
              id: "/subscriptions/{subscriptionId}/resourceGroups/myResourceGroup/providers/Microsoft.KeyVault/vaults/myVMVault",
            },
          },
          encryptionType: "EncryptionAtRestWithCustomerKey",
          identity: { type: "SystemAssigned" },
          location: "West US",
        };
        const credential = new DefaultAzureCredential();
        const client = new ComputeManagementClient(credential, subscriptionId);
        const result = await client.diskEncryptionSets.beginCreateOrUpdateAndWait(
          resourceGroupName,
          diskEncryptionSetName,
          diskEncryptionSet
        );
        console.log(result);
      }

      createADiskEncryptionSet().catch(console.error);

      ```
      Read this [SDK documentation](https://github.com/Azure/azure-sdk-for-js/blob/%40azure%2Farm-compute_18.0.0/sdk/compute/arm-compute/README.md) on how to add the SDK to your project and authenticate.
  responses:
  - statusCode: "202"
    body: >-
      {
        "name": "myDiskEncryptionSet",
        "location": "West US",
        "identity": {
          "type": "SystemAssigned"
        },
        "properties": {
          "activeKey": {
            "sourceVault": {
              "id": "/subscriptions/{subscriptionId}/resourceGroups/myResourceGroup/providers/Microsoft.KeyVault/vaults/myVMVault"
            },
            "keyUrl": "https://myvmvault.vault-int.azure-int.net/keys/{key}"
          },
          "encryptionType": "EncryptionAtRestWithCustomerKey",
          "previousKeys": []
        }
      }
  - statusCode: "200"
    body: >-
      {
        "name": "myDiskEncryptionSet",
        "location": "West US",
        "identity": {
          "type": "SystemAssigned"
        },
        "properties": {
          "activeKey": {
            "sourceVault": {
              "id": "/subscriptions/{subscriptionId}/resourceGroups/myResourceGroup/providers/Microsoft.KeyVault/vaults/myVMVault"
            },
            "keyUrl": "https://myvmvault.vault-int.azure-int.net/keys/{key}"
          },
          "encryptionType": "EncryptionAtRestWithCustomerKey",
          "previousKeys": []
        }
      }
- name: Create a disk encryption set with key vault from a different subscription.
  request:
    uri: PUT https://management.azure.com/subscriptions/{subscription-id}/resourceGroups/myResourceGroup/providers/Microsoft.Compute/diskEncryptionSets/myDiskEncryptionSet?api-version=2021-12-01
    body: >-
      {
        "location": "West US",
        "identity": {
          "type": "SystemAssigned"
        },
        "properties": {
          "activeKey": {
            "keyUrl": "https://myvaultdifferentsub.vault-int.azure-int.net/keys/{key}"
          },
          "encryptionType": "EncryptionAtRestWithCustomerKey"
        }
      }
    codeTab: |+
      # [HTTP](#tab/HTTP)
      ``` http
      PUT https://management.azure.com/subscriptions/{subscription-id}/resourceGroups/myResourceGroup/providers/Microsoft.Compute/diskEncryptionSets/myDiskEncryptionSet?api-version=2021-12-01

      {
        "location": "West US",
        "identity": {
          "type": "SystemAssigned"
        },
        "properties": {
          "activeKey": {
            "keyUrl": "https://myvaultdifferentsub.vault-int.azure-int.net/keys/{key}"
          },
          "encryptionType": "EncryptionAtRestWithCustomerKey"
        }
      }

      ```

      # [Java](#tab/Java)
      ``` java
      import com.azure.core.util.Context;
      import com.azure.resourcemanager.compute.fluent.models.DiskEncryptionSetInner;
      import com.azure.resourcemanager.compute.models.DiskEncryptionSetIdentityType;
      import com.azure.resourcemanager.compute.models.DiskEncryptionSetType;
      import com.azure.resourcemanager.compute.models.EncryptionSetIdentity;
      import com.azure.resourcemanager.compute.models.KeyForDiskEncryptionSet;

      /** Samples for DiskEncryptionSets CreateOrUpdate. */
      public final class Main {
          /*
           * x-ms-original-file: specification/compute/resource-manager/Microsoft.Compute/stable/2021-12-01/examples/CreateADiskEncryptionSetWithKeyVaultFromADifferentSubscription.json
           */
          /**
           * Sample code: Create a disk encryption set with key vault from a different subscription.
           *
           * @param azure The entry point for accessing resource management APIs in Azure.
           */
          public static void createADiskEncryptionSetWithKeyVaultFromADifferentSubscription(
              com.azure.resourcemanager.AzureResourceManager azure) {
              azure
                  .virtualMachines()
                  .manager()
                  .serviceClient()
                  .getDiskEncryptionSets()
                  .createOrUpdate(
                      "myResourceGroup",
                      "myDiskEncryptionSet",
                      new DiskEncryptionSetInner()
                          .withLocation("West US")
                          .withIdentity(new EncryptionSetIdentity().withType(DiskEncryptionSetIdentityType.SYSTEM_ASSIGNED))
                          .withEncryptionType(DiskEncryptionSetType.ENCRYPTION_AT_REST_WITH_CUSTOMER_KEY)
                          .withActiveKey(
                              new KeyForDiskEncryptionSet()
                                  .withKeyUrl("https://myvaultdifferentsub.vault-int.azure-int.net/keys/{key}")),
                      Context.NONE);
          }
      }

      ```
      Read this [SDK documentation](https://github.com/Azure/azure-sdk-for-java/blob/azure-resourcemanager_2.15.0/sdk/resourcemanager/azure-resourcemanager/README.md) on how to add the SDK to your project and authenticate.
      # [Go](#tab/Go)
      ``` go
      package armcompute_test

      import (
      	"context"
      	"log"

      	"github.com/Azure/azure-sdk-for-go/sdk/azcore/to"
      	"github.com/Azure/azure-sdk-for-go/sdk/azidentity"
      	"github.com/Azure/azure-sdk-for-go/sdk/resourcemanager/compute/armcompute"
      )

      // Generated from example definition: https://github.com/Azure/azure-rest-api-specs/tree/main/specification/compute/resource-manager/Microsoft.Compute/stable/2021-12-01/examples/CreateADiskEncryptionSetWithKeyVaultFromADifferentSubscription.json
      func ExampleDiskEncryptionSetsClient_BeginCreateOrUpdate() {
      	cred, err := azidentity.NewDefaultAzureCredential(nil)
      	if err != nil {
      		log.Fatalf("failed to obtain a credential: %v", err)
      	}
      	ctx := context.Background()
      	client, err := armcompute.NewDiskEncryptionSetsClient("{subscription-id}", cred, nil)
      	if err != nil {
      		log.Fatalf("failed to create client: %v", err)
      	}
      	poller, err := client.BeginCreateOrUpdate(ctx,
      		"myResourceGroup",
      		"myDiskEncryptionSet",
      		armcompute.DiskEncryptionSet{
      			Location: to.Ptr("West US"),
      			Identity: &armcompute.EncryptionSetIdentity{
      				Type: to.Ptr(armcompute.DiskEncryptionSetIdentityTypeSystemAssigned),
      			},
      			Properties: &armcompute.EncryptionSetProperties{
      				ActiveKey: &armcompute.KeyForDiskEncryptionSet{
      					KeyURL: to.Ptr("https://myvaultdifferentsub.vault-int.azure-int.net/keys/{key}"),
      				},
      				EncryptionType: to.Ptr(armcompute.DiskEncryptionSetTypeEncryptionAtRestWithCustomerKey),
      			},
      		},
      		nil)
      	if err != nil {
      		log.Fatalf("failed to finish the request: %v", err)
      	}
      	res, err := poller.PollUntilDone(ctx, nil)
      	if err != nil {
      		log.Fatalf("failed to pull the result: %v", err)
      	}
      	// TODO: use response item
      	_ = res
      }

      ```
      Read this [SDK documentation](https://github.com/Azure/azure-sdk-for-go/blob/sdk%2Fresourcemanager%2Fcompute%2Farmcompute%2Fv1.0.0/sdk/resourcemanager/compute/armcompute/README.md) on how to add the SDK to your project and authenticate.
      # [JavaScript](#tab/JavaScript)
      ``` js
      const { ComputeManagementClient } = require("@azure/arm-compute");
      const { DefaultAzureCredential } = require("@azure/identity");

      /**
       * This sample demonstrates how to Creates or updates a disk encryption set
       *
       * @summary Creates or updates a disk encryption set
       * x-ms-original-file: specification/compute/resource-manager/Microsoft.Compute/stable/2021-12-01/examples/CreateADiskEncryptionSetWithKeyVaultFromADifferentSubscription.json
       */
      async function createADiskEncryptionSetWithKeyVaultFromADifferentSubscription() {
        const subscriptionId = "{subscription-id}";
        const resourceGroupName = "myResourceGroup";
        const diskEncryptionSetName = "myDiskEncryptionSet";
        const diskEncryptionSet = {
          activeKey: {
            keyUrl: "https://myvaultdifferentsub.vault-int.azure-int.net/keys/{key}",
          },
          encryptionType: "EncryptionAtRestWithCustomerKey",
          identity: { type: "SystemAssigned" },
          location: "West US",
        };
        const credential = new DefaultAzureCredential();
        const client = new ComputeManagementClient(credential, subscriptionId);
        const result = await client.diskEncryptionSets.beginCreateOrUpdateAndWait(
          resourceGroupName,
          diskEncryptionSetName,
          diskEncryptionSet
        );
        console.log(result);
      }

      createADiskEncryptionSetWithKeyVaultFromADifferentSubscription().catch(console.error);

      ```
      Read this [SDK documentation](https://github.com/Azure/azure-sdk-for-js/blob/%40azure%2Farm-compute_18.0.0/sdk/compute/arm-compute/README.md) on how to add the SDK to your project and authenticate.
  responses:
  - statusCode: "202"
    body: >-
      {
        "name": "myDiskEncryptionSet",
        "location": "West US",
        "identity": {
          "type": "SystemAssigned"
        },
        "properties": {
          "activeKey": {
            "keyUrl": "https://myvaultdifferentsub.vault-int.azure-int.net/keys/{key}"
          },
          "encryptionType": "EncryptionAtRestWithCustomerKey",
          "previousKeys": []
        }
      }
  - statusCode: "200"
    body: >-
      {
        "name": "myDiskEncryptionSet",
        "location": "West US",
        "identity": {
          "type": "SystemAssigned"
        },
        "properties": {
          "activeKey": {
            "keyUrl": "https://myvaultdifferentsub.vault-int.azure-int.net/keys/{key}"
          },
          "encryptionType": "EncryptionAtRestWithCustomerKey",
          "previousKeys": []
        }
      }
security:
- name: azure_auth
  type: oauth2
  description: Azure Active Directory OAuth2 Flow
  flow: implicit
  authorizationUrl: https://login.microsoftonline.com/common/oauth2/authorize
  scopes:
  - name: user_impersonation
    description: impersonate your user account
metadata:
  description: >
    Learn more about Compute service - Creates or updates a disk encryption set
errorCodes: []
